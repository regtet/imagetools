<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å›¾ç‰‡å¤„ç†å·¥å…·</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }

  .header {
    text-align: center;
    margin-bottom: 20px;
  }

  .header h1 {
    color: #333;
    margin: 0;
    font-size: 2.5em;
    font-weight: 300;
  }

  .header p {
    color: #666;
    margin: 10px 0 0 0;
    font-size: 1.1em;
  }

  .tabs {
    display: flex;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 20px;
  }

  .tab {
    padding: 15px 30px;
    background: #f8f9fa;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    color: #666;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
  }

  .tab.active {
    background: #fff;
    color: #0078d4;
    border-bottom-color: #0078d4;
  }

  .tab:hover {
    background: #e9ecef;
    color: #0078d4;
  }

  .tab-content {
    display: none;
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 8px 18px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 600px;
    text-align: center;
  }

  .tab-content.active {
    display: block;
  }

  h2 {
    color: #333;
    margin-bottom: 20px;
    font-size: 1.8em;
    font-weight: 400;
  }

  .drop-area {
    display: flex;
    padding: 30px;
    border: 2px dashed #bbb;
    border-radius: 12px;
    background: #fafafa;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 20px;
    justify-content: center;
    align-items: center;
    font-size: 16px;
    color: #666;
  }

  .drop-area.hover {
    border-color: #0078d4;
    background: #f0f8ff;
    color: #0078d4;
  }

  .img-container {
    width: 100%;
    max-height: 400px;
    margin: 20px 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    background: #fafafa;
  }

  .img-container img,
  .img-container canvas {
    max-width: 100%;
    max-height: 100%;
    display: block;
    margin: auto;
  }

  input[type="number"], input[type="text"] {
    width: 100px;
    padding: 8px;
    margin: 0 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    text-align: center;
    font-size: 14px;
    transition: border-color 0.3s ease;
  }

  input[type="number"]:focus, input[type="text"]:focus {
    outline: none;
    border-color: #0078d4;
  }

  .controls {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
  }

  .control-group {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .control-group label {
    font-weight: 500;
    color: #555;
  }

  button {
    padding: 10px 20px;
    margin: 8px;
    border: none;
    border-radius: 8px;
    background-color: #0078d4;
    color: #fff;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  button:hover {
    background-color: #005a9e;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  input[type="file"] {
    display: none;
  }

  .batch-info {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    color: #1976d2;
    font-size: 14px;
  }

  .color-preview {
    display: inline-block;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin: 0 5px;
    border: 2px solid #ddd;
    vertical-align: middle;
  }
</style>
</head>
<body>
  <div class="header">
    <h1>å›¾ç‰‡å¤„ç†å·¥å…·</h1>
    <p>ä¸“ä¸šçš„åœ¨çº¿å›¾ç‰‡ç¼–è¾‘å·¥å…·ï¼Œæ”¯æŒè£å‰ªã€é¢œè‰²æ›¿æ¢ã€æ‰¹é‡é‡å‘½åã€å›¾ç‰‡å åŠ ç­‰åŠŸèƒ½</p>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="crop">å›¾ç‰‡è£å‰ª</button>
    <button class="tab" data-tab="replace">é¢œè‰²æ›¿æ¢</button>
    <button class="tab" data-tab="rename">æ‰¹é‡é‡å‘½å</button>
    <button class="tab" data-tab="overlay">å›¾ç‰‡å åŠ </button>
  </div>

  <!-- è£å‰ªå·¥å…· -->
  <div class="tab-content active" id="crop">
    <h2>å›¾ç‰‡è£å‰ªå·¥å…·</h2>
    <label class="drop-area" id="dropCrop">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡
      <input type="file" id="uploadCrop" accept="image/*">
    </label>

    <div class="img-container">
      <img id="imageCrop" alt="è¯·ä¸Šä¼ å›¾ç‰‡">
    </div>

    <div class="controls">
      <div class="control-group">
        <label>X:</label>
        <input type="number" id="posX" value="55">
      </div>
      <div class="control-group">
        <label>Y:</label>
        <input type="number" id="posY" value="0">
      </div>
      <div class="control-group">
        <label>W:</label>
        <input type="number" id="width" value="341">
      </div>
      <div class="control-group">
        <label>H:</label>
        <input type="number" id="height" value="65">
      </div>
      <button id="applyCrop">åº”ç”¨è£å‰ª</button>
    </div>

    <div style="margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
      <button id="preset1" style="background: #6c757d;">é¢„è®¾1 (55,0,341,65)</button>
      <button id="preset2" style="background: #6c757d;">é¢„è®¾2 (65,0,411,65)</button>
    </div>

    <div id="customPresets" style="margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
      <!-- è‡ªå®šä¹‰é¢„è®¾æŒ‰é’®å°†åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
    </div>

    <div style="margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
      <button id="savePreset" style="background: #28a745;">ä¿å­˜å½“å‰å€¼ä¸ºé¢„è®¾</button>
      <button id="managePresets" style="background: #17a2b8;">ç®¡ç†é¢„è®¾</button>
    </div>

    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
    <button id="downloadCrop">ä¸‹è½½è£å‰ªåçš„å›¾ç‰‡</button>
      <button id="resetCrop" style="background: #dc3545;">é‡ç½®å·¥å…·</button>
    </div>
  </div>

  <!-- é¢œè‰²æ›¿æ¢å·¥å…· -->
  <div class="tab-content" id="replace">
    <h2>å›¾ç‰‡é¢œè‰²æ›¿æ¢å·¥å…·</h2>
    <div class="batch-info">
      ğŸ’¡ æ”¯æŒæ‰¹é‡å¤„ç†ï¼šä¸Šä¼ å¤šå¼ å›¾ç‰‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºæ¯å¼ å›¾ç‰‡åº”ç”¨ç›¸åŒçš„é¢œè‰²æ›¿æ¢è®¾ç½®<br>
      ğŸ¨ æ”¯æŒå¤šç§é¢œè‰²æ ¼å¼ï¼šåå…­è¿›åˆ¶ï¼ˆ#ff0000ï¼‰ã€å‘½åé¢œè‰²ï¼ˆredã€blueï¼‰ã€RGBï¼ˆrgb(255,0,0)ï¼‰
    </div>

    <label class="drop-area" id="dropReplace">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
      <input type="file" id="uploadReplace" accept="image/*" multiple>
    </label>

    <div id="imageGrid" style="display: none; margin: 15px 0;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h4 style="margin: 0; color: #333;">å›¾ç‰‡é¢„è§ˆ</h4>
        <span id="uploadCount" style="background: #0078d4; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 500;"></span>
      </div>
      <div id="gridContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>åŸé¢œè‰²:</label>
        <span class="color-preview" id="fromColorPreview" style="background-color: #000000;"></span>
        <input type="text" id="fromColor" value="#000000" placeholder="å¦‚: #000000 æˆ– black">
      </div>
      <div class="control-group">
        <label>ç›®æ ‡é¢œè‰²:</label>
        <span class="color-preview" id="toColorPreview" style="background-color: #ff0000;"></span>
        <input type="text" id="toColor" value="#ff0000" placeholder="å¦‚: #ff0000 æˆ– red">
      </div>
      <div class="control-group">
        <label>å®¹å·®:</label>
        <input type="number" id="tolerance" value="999" min="0" max="441">
      </div>
    </div>

    <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
    <button id="downloadReplace">ä¸‹è½½ä¿®æ”¹åçš„å›¾ç‰‡</button>
    <button id="downloadAllReplace" style="display: none;">ä¸‹è½½æ‰€æœ‰å›¾ç‰‡</button>
      <button id="resetReplace" style="background: #dc3545;">é‡ç½®å·¥å…·</button>
    </div>
  </div>

  <!-- æ‰¹é‡é‡å‘½åå·¥å…· -->
  <div class="tab-content" id="rename">
    <h2>æ‰¹é‡é‡å‘½åå›¾ç‰‡åç¼€</h2>
    <div class="batch-info">
      âœï¸ æ‰¹é‡é‡å‘½åï¼šä¸Šä¼ å¤šå¼ å›¾ç‰‡ï¼Œä¸€é”®ä¿®æ”¹æ‰€æœ‰å›¾ç‰‡çš„æ–‡ä»¶åç¼€å<br>
      ğŸ“¦ é¢„è®¾åç¼€ï¼š.pngã€.jpgã€.webpã€.avifã€.bmpã€.gif ç­‰å¸¸ç”¨æ ¼å¼<br>
      âš¡ æ³¨æ„ï¼šä»…ä¿®æ”¹æ–‡ä»¶ååç¼€ï¼Œä¸è¿›è¡Œå®é™…æ ¼å¼è½¬æ¢
    </div>

    <label class="drop-area" id="dropRename">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
      <input type="file" id="uploadRename" accept="image/*" multiple>
    </label>

    <div id="renameImageGrid" style="display: none; margin: 15px 0;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h4 style="margin: 0; color: #333;">å›¾ç‰‡åˆ—è¡¨</h4>
        <span id="renameUploadCount" style="background: #0078d4; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 500;"></span>
      </div>
      <div id="renameGridContainer" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px;"></div>
    </div>

    <div class="controls" style="flex-direction: column; gap: 20px; margin-top: 20px;">
      <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
        <button class="format-btn" data-format="png" style="background: #6f42c1;">.png</button>
        <button class="format-btn" data-format="jpg" style="background: #e83e8c;">.jpg</button>
        <button class="format-btn" data-format="jpeg" style="background: #d63384;">.jpeg</button>
        <button class="format-btn" data-format="webp" style="background: #20c997;">.webp</button>
        <button class="format-btn" data-format="avif" style="background: #fd7e14;">.avif</button>
        <button class="format-btn" data-format="bmp" style="background: #6c757d;">.bmp</button>
        <button class="format-btn" data-format="gif" style="background: #17a2b8;">.gif</button>
      </div>

      <div style="display: flex; align-items: center; gap: 10px;">
        <label style="font-weight: 500; color: #555;">ç›®æ ‡åç¼€:</label>
        <select id="targetFormat" style="padding: 8px 15px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; min-width: 120px;">
          <option value="png">.png</option>
          <option value="jpg">.jpg</option>
          <option value="jpeg">.jpeg</option>
          <option value="webp">.webp</option>
          <option value="avif">.avif</option>
          <option value="bmp">.bmp</option>
          <option value="gif">.gif</option>
        </select>
      </div>
    </div>

    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
      <button id="downloadAllRenamed" style="display: none;">ä¸‹è½½æ‰€æœ‰é‡å‘½ååçš„å›¾ç‰‡</button>
      <button id="resetRename" style="background: #dc3545;">é‡ç½®å·¥å…·</button>
    </div>
  </div>

  <!-- å›¾ç‰‡å åŠ å·¥å…· -->
  <div class="tab-content" id="overlay">
    <h2>å›¾ç‰‡å åŠ å·¥å…·</h2>
    <div class="batch-info">
      ğŸ–¼ï¸ å›¾ç‰‡å åŠ ï¼šå°†ä¸€å¼ å›¾ç‰‡å åŠ åˆ°å¦ä¸€å¼ å›¾ç‰‡ä¸Šï¼Œå¯è‡ªç”±è°ƒæ•´ä½ç½®å’Œå¤§å°<br>
      ğŸ¯ æ‹–æ‹½å®šä½ï¼šç›´æ¥æ‹–æ‹½å åŠ å›¾ç‰‡åˆ°ç›®æ ‡ä½ç½®<br>
      ğŸ“ å°ºå¯¸è°ƒæ•´ï¼šæ‹–æ‹½å››ä¸ªè§’è°ƒæ•´å¤§å°ï¼Œè‡ªåŠ¨ä¿æŒçºµæ¨ªæ¯”
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
      <div>
        <h4 style="margin: 0 0 10px 0; color: #333; text-align: center;">èƒŒæ™¯å›¾ç‰‡</h4>
        <label class="drop-area" id="dropBackground" style="padding: 20px; font-size: 14px;">
          æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ èƒŒæ™¯å›¾
          <input type="file" id="uploadBackground" accept="image/*">
        </label>
      </div>
      <div>
        <h4 style="margin: 0 0 10px 0; color: #333; text-align: center;">å åŠ å›¾ç‰‡</h4>
        <label class="drop-area" id="dropOverlay" style="padding: 20px; font-size: 14px;">
          æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ å åŠ å›¾
          <input type="file" id="uploadOverlay" accept="image/*">
        </label>
      </div>
    </div>

    <div style="position: relative; margin: 20px 0;">
      <canvas id="overlayCanvas" style="max-width: 100%; border: 2px solid #ddd; border-radius: 8px; display: none; cursor: move;"></canvas>
      <div id="overlayPlaceholder" style="padding: 60px; text-align: center; border: 2px dashed #ccc; border-radius: 8px; color: #999; background: #fafafa;">
        è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾ç‰‡å’Œå åŠ å›¾ç‰‡
      </div>
    </div>

    <div class="controls" style="flex-wrap: wrap;">
      <button id="centerHorizontal" style="background: #6f42c1;" disabled>æ°´å¹³å±…ä¸­</button>
      <button id="centerVertical" style="background: #e83e8c;" disabled>å‚ç›´å±…ä¸­</button>
      <button id="centerBoth" style="background: #20c997;" disabled>å®Œå…¨å±…ä¸­</button>
      <button id="resetOverlay" style="background: #fd7e14;" disabled>é‡ç½®ä½ç½®</button>
      <button id="fitToBackground" style="background: #17a2b8;" disabled>é€‚åº”èƒŒæ™¯</button>
    </div>

    <div class="controls" style="margin-top: 10px;">
      <div class="control-group">
        <label>å åŠ å›¾ä¸é€æ˜åº¦:</label>
        <input type="range" id="overlayOpacity" min="0" max="100" value="100" style="width: 150px;" disabled>
        <span id="opacityValue" style="font-weight: 500; color: #0078d4;">100%</span>
      </div>
    </div>

    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
      <button id="downloadOverlay" disabled>ä¸‹è½½åˆæˆåçš„å›¾ç‰‡</button>
      <button id="resetOverlayTool" style="background: #dc3545;">é‡ç½®å·¥å…·</button>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
/* ======= æ ‡ç­¾é¡µåˆ‡æ¢ ======= */
document.addEventListener('DOMContentLoaded', function() {
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));

      // æ·»åŠ å½“å‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
      tab.classList.add('active');
      const targetTab = tab.getAttribute('data-tab');
      document.getElementById(targetTab).classList.add('active');
    });
  });
});

/* ======= è£å‰ªå·¥å…· ======= */
let cropper, cropFileName = "cropped.png";
const imageCrop = document.getElementById('imageCrop');
const uploadCrop = document.getElementById('uploadCrop');
const downloadCrop = document.getElementById('downloadCrop');
const applyCrop = document.getElementById('applyCrop');
const preset1Btn = document.getElementById('preset1');
const preset2Btn = document.getElementById('preset2');
const savePresetBtn = document.getElementById('savePreset');
const managePresetsBtn = document.getElementById('managePresets');
const customPresetsContainer = document.getElementById('customPresets');

const posX = document.getElementById('posX');
const posY = document.getElementById('posY');
const width = document.getElementById('width');
const height = document.getElementById('height');

// å›ºå®šé¢„è®¾å€¼
const CROP_PRESETS = {
  preset1: {
    x: 55,
    y: 0,
    width: 341,
    height: 65
  },
  preset2: {
    x: 65,
    y: 0,
    width: 411,
    height: 65
  }
};

// é»˜è®¤ä½¿ç”¨é¢„è®¾1
const DEFAULT_CROP_VALUES = CROP_PRESETS.preset1;

// localStorage key
const CUSTOM_PRESETS_KEY = 'cropCustomPresets';

// ä»localStorageåŠ è½½è‡ªå®šä¹‰é¢„è®¾
function loadCustomPresets() {
  const saved = localStorage.getItem(CUSTOM_PRESETS_KEY);
  return saved ? JSON.parse(saved) : [];
}

// ä¿å­˜è‡ªå®šä¹‰é¢„è®¾åˆ°localStorage
function saveCustomPresets(presets) {
  localStorage.setItem(CUSTOM_PRESETS_KEY, JSON.stringify(presets));
}

// æ¸²æŸ“è‡ªå®šä¹‰é¢„è®¾æŒ‰é’®
function renderCustomPresets() {
  const customPresets = loadCustomPresets();
  customPresetsContainer.innerHTML = '';

  if (customPresets.length === 0) {
    customPresetsContainer.style.display = 'none';
    return;
  }

  customPresetsContainer.style.display = 'flex';

  customPresets.forEach((preset, index) => {
    const btn = document.createElement('button');
    btn.style.cssText = 'background: #fd7e14; position: relative; padding-right: 35px;';
    btn.innerHTML = `${preset.name || 'è‡ªå®šä¹‰' + (index + 1)} (${preset.x},${preset.y},${preset.width},${preset.height})`;

    btn.addEventListener('click', () => {
      applyPreset(preset);
    });

    customPresetsContainer.appendChild(btn);
  });
}

function handleCropFile(file){
  if (!file) return;
  cropFileName = file.name.replace(/\.[^/.]+$/, "") + ".png";
  const url = URL.createObjectURL(file);
  imageCrop.src = url;

  if (cropper) cropper.destroy();
  cropper = new Cropper(imageCrop, {
    aspectRatio: NaN,
    viewMode: 1,
    autoCropArea: 0.3,
    crop(event) {
      posX.value = Math.round(event.detail.x);
      posY.value = Math.round(event.detail.y);
      width.value = Math.round(event.detail.width);
      height.value = Math.round(event.detail.height);
    },
    ready() {
      cropper.setData(DEFAULT_CROP_VALUES);
    }
  });
}

uploadCrop.addEventListener('change', e => handleCropFile(e.target.files[0]));

// æ‹–æ‹½ä¸Šä¼ 
const dropCrop = document.getElementById('dropCrop');
dropCrop.addEventListener('dragover', e => { e.preventDefault(); dropCrop.classList.add('hover'); });
dropCrop.addEventListener('dragleave', e => { e.preventDefault(); dropCrop.classList.remove('hover'); });
dropCrop.addEventListener('drop', e => {
  e.preventDefault();
  dropCrop.classList.remove('hover');
  const file = e.dataTransfer.files[0];
  handleCropFile(file);
});

applyCrop.addEventListener('click', () => {
  if (!cropper) {
    alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡");
    return;
  }

  const x = parseInt(posX.value) || 0;
  const y = parseInt(posY.value) || 0;
  const w = parseInt(width.value) || 100;
  const h = parseInt(height.value) || 100;

  cropper.setData({ x, y, width: w, height: h });
});

downloadCrop.addEventListener('click', () => {
  if (!cropper) return alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡");
  const canvas = cropper.getCroppedCanvas();
  canvas.toBlob(blob => {
    const link = document.createElement('a');
    link.download = cropFileName;
    link.href = URL.createObjectURL(blob);
    link.click();
  });
});

// åº”ç”¨é¢„è®¾å€¼çš„é€šç”¨å‡½æ•°
function applyPreset(presetValues) {
  // æ›´æ–°è¾“å…¥æ¡†å€¼
  posX.value = presetValues.x;
  posY.value = presetValues.y;
  width.value = presetValues.width;
  height.value = presetValues.height;

  // å¦‚æœæœ‰å›¾ç‰‡ï¼Œåº”ç”¨è£å‰ª
  if (cropper) {
    cropper.setData(presetValues);
  }
}

// é¢„è®¾1æŒ‰é’®
preset1Btn.addEventListener('click', () => {
  applyPreset(CROP_PRESETS.preset1);
});

// é¢„è®¾2æŒ‰é’®
preset2Btn.addEventListener('click', () => {
  applyPreset(CROP_PRESETS.preset2);
});

// ä¿å­˜å½“å‰å€¼ä¸ºé¢„è®¾
savePresetBtn.addEventListener('click', () => {
  const name = prompt('è¯·è¾“å…¥é¢„è®¾åç§°ï¼š', 'æˆ‘çš„é¢„è®¾');
  if (!name) return;

  const newPreset = {
    name: name,
    x: parseInt(posX.value) || 0,
    y: parseInt(posY.value) || 0,
    width: parseInt(width.value) || 100,
    height: parseInt(height.value) || 100
  };

  const customPresets = loadCustomPresets();
  customPresets.push(newPreset);
  saveCustomPresets(customPresets);
  renderCustomPresets();

  alert('é¢„è®¾å·²ä¿å­˜ï¼');
});

// ç®¡ç†é¢„è®¾
managePresetsBtn.addEventListener('click', () => {
  const customPresets = loadCustomPresets();

  if (customPresets.length === 0) {
    alert('æš‚æ— è‡ªå®šä¹‰é¢„è®¾');
    return;
  }

  let message = 'å½“å‰è‡ªå®šä¹‰é¢„è®¾åˆ—è¡¨ï¼š\n\n';
  customPresets.forEach((preset, index) => {
    message += `${index + 1}. ${preset.name} (${preset.x},${preset.y},${preset.width},${preset.height})\n`;
  });
  message += '\nè¾“å…¥è¦åˆ é™¤çš„é¢„è®¾ç¼–å·ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰ï¼Œæˆ–ç‚¹å‡»å–æ¶ˆè¿”å›ï¼š';

  const input = prompt(message);
  if (!input) return;

  const indexesToDelete = input.split(',').map(i => parseInt(i.trim()) - 1).filter(i => i >= 0 && i < customPresets.length);

  if (indexesToDelete.length === 0) {
    alert('æ²¡æœ‰æœ‰æ•ˆçš„ç¼–å·');
    return;
  }

  // ä»åå¾€å‰åˆ é™¤ï¼Œé¿å…ç´¢å¼•å˜åŒ–
  indexesToDelete.sort((a, b) => b - a).forEach(index => {
    customPresets.splice(index, 1);
  });

  saveCustomPresets(customPresets);
  renderCustomPresets();

  alert(`å·²åˆ é™¤ ${indexesToDelete.length} ä¸ªé¢„è®¾`);
});

// é¡µé¢åŠ è½½æ—¶æ¸²æŸ“è‡ªå®šä¹‰é¢„è®¾
renderCustomPresets();

// é‡ç½®è£å‰ªå·¥å…·
const resetCropBtn = document.getElementById('resetCrop');
resetCropBtn.addEventListener('click', () => {
  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
  imageCrop.src = '';
  uploadCrop.value = '';
  posX.value = 55;
  posY.value = 0;
  width.value = 341;
  height.value = 65;
  cropFileName = "cropped.png";
});

/* ======= é¢œè‰²æ›¿æ¢å·¥å…· ======= */
let uploadedFiles = [];
let currentFileIndex = 0;
let processedImages = [];

const uploadReplace = document.getElementById("uploadReplace");
const fromColor = document.getElementById("fromColor");
const toColor = document.getElementById("toColor");
const toleranceInput = document.getElementById("tolerance");
const downloadReplace = document.getElementById("downloadReplace");
const downloadAllReplace = document.getElementById("downloadAllReplace");
const fromColorPreview = document.getElementById("fromColorPreview");
const toColorPreview = document.getElementById("toColorPreview");
const imageGrid = document.getElementById("imageGrid");
const gridContainer = document.getElementById("gridContainer");
const uploadCount = document.getElementById("uploadCount");

// é¢œè‰²é¢„è§ˆæ›´æ–°
function updateColorPreviews() {
  try {
    fromColorPreview.style.backgroundColor = fromColor.value;
    toColorPreview.style.backgroundColor = toColor.value;
  } catch (e) {
    console.warn('é¢œè‰²æ ¼å¼å¯èƒ½ä¸æ­£ç¡®:', e);
  }
}

fromColor.addEventListener('input', updateColorPreviews);
toColor.addEventListener('input', updateColorPreviews);

// å®æ—¶é¢œè‰²æ›¿æ¢ - å¤„ç†æ‰€æœ‰å›¾ç‰‡
function applyColorReplace() {
  if (uploadedFiles.length === 0) return;

  // ä¸ºæ¯å¼ å›¾ç‰‡åˆ›å»ºå¤„ç†åçš„canvas
  uploadedFiles.forEach((file, index) => {
    const img = new Image();
    img.onload = () => {
      // åˆ›å»ºä¸´æ—¶canvasè¿›è¡Œå¤„ç†
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');

      tempCanvas.width = img.width;
      tempCanvas.height = img.height;
      tempCtx.drawImage(img, 0, 0);

      // è·å–å›¾åƒæ•°æ®
      const imgData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
      const data = imgData.data;

      // é¢œè‰²æ›¿æ¢å¤„ç†
      const [fr, fg, fb] = hexToRgb(fromColor.value);
      const [tr, tg, tb] = hexToRgb(toColor.value);
      const tolerance = parseInt(toleranceInput.value) || 0;

      for (let i = 0; i < data.length; i += 4) {
        const dr = data[i] - fr;
        const dg = data[i+1] - fg;
        const db = data[i+2] - fb;
        const dist = Math.sqrt(dr*dr + dg*dg + db*db);

        if (dist <= tolerance) {
          data[i] = tr;
          data[i+1] = tg;
          data[i+2] = tb;
        }
      }

      // åº”ç”¨å¤„ç†åçš„å›¾åƒæ•°æ®
      tempCtx.putImageData(imgData, 0, 0);

      // ä¿å­˜å¤„ç†åçš„å›¾ç‰‡æ•°æ®
      processedImages[index] = tempCanvas.toDataURL("image/png");

      // æ›´æ–°ç½‘æ ¼ä¸­å¯¹åº”å›¾ç‰‡çš„æ˜¾ç¤º
      updateGridImage(index, processedImages[index]);
    };

    img.onerror = () => {
      console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', file.name);
    };

    const url = URL.createObjectURL(file);
    img.src = url;
  });
}

// æ›´æ–°ç½‘æ ¼ä¸­æŒ‡å®šå›¾ç‰‡çš„æ˜¾ç¤º
function updateGridImage(index, processedImageData) {
  const gridItems = gridContainer.children;
  if (gridItems[index]) {
    const img = gridItems[index].querySelector('img');
    if (img && processedImageData) {
      img.src = processedImageData;
    }
  }
}

// é˜²æŠ–å‡½æ•°
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// åˆ›å»ºé˜²æŠ–çš„é¢œè‰²æ›¿æ¢å‡½æ•°
const debouncedApplyColorReplace = debounce(applyColorReplace, 100);

// ç›‘å¬é¢œè‰²å’Œå®¹å·®å˜åŒ–ï¼Œå®æ—¶åº”ç”¨æ›¿æ¢
fromColor.addEventListener('input', debouncedApplyColorReplace);
toColor.addEventListener('input', debouncedApplyColorReplace);
toleranceInput.addEventListener('input', debouncedApplyColorReplace);

function handleReplaceFiles(files) {
  console.log('ä¸Šä¼ æ–‡ä»¶æ•°é‡:', files.length);

  if (!files || files.length === 0) {
    console.log('æ²¡æœ‰æ–‡ä»¶ä¸Šä¼ ');
    return;
  }

  // éªŒè¯æ–‡ä»¶ç±»å‹
  const validFiles = Array.from(files).filter(file => {
    const isValid = file.type.startsWith('image/');
    if (!isValid) {
      console.warn('æ— æ•ˆæ–‡ä»¶ç±»å‹:', file.name, file.type);
    }
    return isValid;
  });

  if (validFiles.length === 0) {
    alert('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
    return;
  }

  uploadedFiles = validFiles;
  processedImages = new Array(validFiles.length);
  currentFileIndex = 0;

  console.log('æœ‰æ•ˆæ–‡ä»¶æ•°é‡:', uploadedFiles.length);

  // æ˜¾ç¤ºå›¾ç‰‡ç½‘æ ¼
  imageGrid.style.display = 'block';
  updateImageGrid();

  if (validFiles.length > 1) {
    downloadAllReplace.style.display = 'inline-block';
  } else {
    downloadAllReplace.style.display = 'none';
  }

  applyColorReplace();
}

function updateImageGrid() {
  // æ›´æ–°ä¸Šä¼ æ€»æ•°
  uploadCount.textContent = `å·²ä¸Šä¼  ${uploadedFiles.length} å¼ `;

  gridContainer.innerHTML = '';

  uploadedFiles.forEach((file, index) => {
    const gridItem = document.createElement('div');
    gridItem.style.cssText = `
      position: relative;
      border: 2px solid ${index === currentFileIndex ? '#0078d4' : '#dee2e6'};
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8f9fa;
    `;

    const img = document.createElement('img');
    img.style.cssText = `
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    `;

    const fileName = document.createElement('div');
    fileName.style.cssText = `
      padding: 8px;
      font-size: 12px;
      color: #666;
      text-align: center;
      background: rgba(255,255,255,0.9);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    `;
    fileName.textContent = file.name;

    const statusIndicator = document.createElement('div');
    statusIndicator.style.cssText = `
      position: absolute;
      top: 5px;
      right: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: ${processedImages[index] ? '#28a745' : '#ffc107'};
      border: 2px solid #fff;
    `;

    gridItem.appendChild(img);
    gridItem.appendChild(fileName);
    gridItem.appendChild(statusIndicator);

    // åŠ è½½å›¾ç‰‡ - å¦‚æœå·²å¤„ç†åˆ™æ˜¾ç¤ºå¤„ç†åçš„å›¾ç‰‡ï¼Œå¦åˆ™æ˜¾ç¤ºåŸå›¾
    if (processedImages[index]) {
      img.src = processedImages[index];
    } else {
      const url = URL.createObjectURL(file);
      img.src = url;
    }

    // ç‚¹å‡»åˆ‡æ¢å½“å‰é€‰ä¸­å›¾ç‰‡
    gridItem.addEventListener('click', () => {
      currentFileIndex = index;
      updateImageGrid();
    });

    // æ‚¬åœæ•ˆæœ
    gridItem.addEventListener('mouseenter', () => {
      if (index !== currentFileIndex) {
        gridItem.style.borderColor = '#0078d4';
        gridItem.style.transform = 'scale(1.02)';
      }
    });

    gridItem.addEventListener('mouseleave', () => {
      if (index !== currentFileIndex) {
        gridItem.style.borderColor = '#dee2e6';
        gridItem.style.transform = 'scale(1)';
      }
    });

    gridContainer.appendChild(gridItem);
  });
}

uploadReplace.addEventListener("change", e => handleReplaceFiles(e.target.files));

const dropReplace = document.getElementById('dropReplace');
dropReplace.addEventListener('dragover', e => { e.preventDefault(); dropReplace.classList.add('hover'); });
dropReplace.addEventListener('dragleave', e => { e.preventDefault(); dropReplace.classList.remove('hover'); });
dropReplace.addEventListener('drop', e => {
  e.preventDefault();
  dropReplace.classList.remove('hover');
  handleReplaceFiles(e.dataTransfer.files);
});

// å°†é¢œè‰²å€¼è½¬æ¢ä¸ºRGBæ•°ç»„ï¼Œæ”¯æŒåå…­è¿›åˆ¶ï¼ˆ#ff0000ï¼‰å’Œå‘½åé¢œè‰²ï¼ˆredï¼‰
function colorToRgb(color) {
  // å»é™¤ç©ºæ ¼
  color = color.trim();

  // å¦‚æœæ˜¯åå…­è¿›åˆ¶é¢œè‰²
  if (color.startsWith('#')) {
    const hex = color.replace("#", "");
    const bigint = parseInt(hex, 16);
    return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
  }

  // å¦‚æœæ˜¯rgb/rgbaæ ¼å¼
  if (color.startsWith('rgb')) {
    const match = color.match(/\d+/g);
    if (match && match.length >= 3) {
      return [parseInt(match[0]), parseInt(match[1]), parseInt(match[2])];
    }
  }

  // å¯¹äºå‘½åé¢œè‰²ï¼Œä½¿ç”¨canvasæ¥è½¬æ¢
  const canvas = document.createElement('canvas');
  canvas.width = canvas.height = 1;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = color;
  ctx.fillRect(0, 0, 1, 1);
  const imageData = ctx.getImageData(0, 0, 1, 1).data;
  return [imageData[0], imageData[1], imageData[2]];
}

// ä¿ç•™æ—§å‡½æ•°åä»¥å…¼å®¹
function hexToRgb(hex) {
  return colorToRgb(hex);
}

downloadReplace.addEventListener("click", () => {
  if (uploadedFiles.length === 0) return;
  if (!processedImages[currentFileIndex]) return;

  const link = document.createElement("a");
  const fileName = uploadedFiles[currentFileIndex].name.replace(/\.[^/.]+$/, "") + "_replaced.png";
  link.download = fileName;
  link.href = processedImages[currentFileIndex];
  link.click();
});

downloadAllReplace.addEventListener("click", () => {
  if (uploadedFiles.length === 0) return;

  // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å›¾ç‰‡éƒ½å·²å¤„ç†
  const allProcessed = processedImages.every(img => img !== undefined);
  if (!allProcessed) return;

  // æ‰¹é‡ä¸‹è½½æ‰€æœ‰å›¾ç‰‡
  uploadedFiles.forEach((file, index) => {
    setTimeout(() => {
      const link = document.createElement("a");
      const fileName = file.name.replace(/\.[^/.]+$/, "") + "_replaced.png";
      link.download = fileName;
      link.href = processedImages[index];
      link.click();
    }, index * 200);
  });
});

// é‡ç½®é¢œè‰²æ›¿æ¢å·¥å…·
const resetReplaceBtn = document.getElementById('resetReplace');
resetReplaceBtn.addEventListener('click', () => {
  uploadedFiles = [];
  processedImages = [];
  currentFileIndex = 0;
  uploadReplace.value = '';
  imageGrid.style.display = 'none';
  gridContainer.innerHTML = '';
  downloadAllReplace.style.display = 'none';
  fromColor.value = '#000000';
  toColor.value = '#ff0000';
  toleranceInput.value = 999;
  updateColorPreviews();
});

/* ======= æ‰¹é‡é‡å‘½åå·¥å…· ======= */
let renameFiles = [];

const uploadRename = document.getElementById("uploadRename");
const dropRename = document.getElementById("dropRename");
const renameImageGrid = document.getElementById("renameImageGrid");
const renameGridContainer = document.getElementById("renameGridContainer");
const renameUploadCount = document.getElementById("renameUploadCount");
const targetFormat = document.getElementById("targetFormat");
const downloadAllRenamed = document.getElementById("downloadAllRenamed");
const formatBtns = document.querySelectorAll(".format-btn");

// æ ¼å¼æŒ‰é’®ç‚¹å‡»
formatBtns.forEach(btn => {
  btn.addEventListener("click", () => {
    const format = btn.getAttribute("data-format");
    targetFormat.value = format;
    if (renameFiles.length > 0) {
      updateRenameGrid();
    }
  });
});

// ç›®æ ‡æ ¼å¼æ”¹å˜
targetFormat.addEventListener("change", () => {
  if (renameFiles.length > 0) {
    updateRenameGrid();
  }
});

// å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
function handleRenameFiles(files) {
  if (!files || files.length === 0) return;

  const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

  if (validFiles.length === 0) {
    alert('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
    return;
  }

  renameFiles = validFiles;

  renameImageGrid.style.display = 'block';
  downloadAllRenamed.style.display = 'inline-block';

  updateRenameGrid();
}

// æ›´æ–°å›¾ç‰‡åˆ—è¡¨æ˜¾ç¤º
function updateRenameGrid() {
  renameUploadCount.textContent = `å·²ä¸Šä¼  ${renameFiles.length} å¼ `;
  renameGridContainer.innerHTML = '';

  renameFiles.forEach((file, index) => {
    const itemDiv = document.createElement('div');
    itemDiv.style.cssText = `
      display: flex;
      align-items: center;
      background: #fff;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    `;

    const img = document.createElement('img');
    img.style.cssText = `
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 15px;
      border: 2px solid #dee2e6;
    `;
    img.src = URL.createObjectURL(file);

    const infoDiv = document.createElement('div');
    infoDiv.style.cssText = `
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
    `;

    const originalName = document.createElement('div');
    originalName.style.cssText = `
      font-size: 14px;
      color: #666;
      font-weight: 400;
    `;
    originalName.textContent = `åŸæ–‡ä»¶: ${file.name}`;

    const arrow = document.createElement('div');
    arrow.style.cssText = `
      font-size: 16px;
      color: #0078d4;
      font-weight: bold;
    `;
    arrow.textContent = 'â†“';

    const newName = document.createElement('div');
    newName.style.cssText = `
      font-size: 14px;
      color: #0078d4;
      font-weight: 500;
    `;
    newName.id = `newName-${index}`;
    const newFileName = getNewFileName(file.name, targetFormat.value);
    newName.textContent = `æ–°æ–‡ä»¶: ${newFileName}`;

    infoDiv.appendChild(originalName);
    infoDiv.appendChild(arrow);
    infoDiv.appendChild(newName);

    itemDiv.appendChild(img);
    itemDiv.appendChild(infoDiv);

    // æ‚¬åœæ•ˆæœ
    itemDiv.addEventListener('mouseenter', () => {
      itemDiv.style.transform = 'translateX(5px)';
      itemDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
    });

    itemDiv.addEventListener('mouseleave', () => {
      itemDiv.style.transform = 'translateX(0)';
      itemDiv.style.boxShadow = '0 2px 6px rgba(0,0,0,0.08)';
    });

    renameGridContainer.appendChild(itemDiv);
  });
}

// è·å–æ–°æ–‡ä»¶å
function getNewFileName(originalName, format) {
  const nameWithoutExt = originalName.replace(/\.[^/.]+$/, "");
  return `${nameWithoutExt}.${format}`;
}

// æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
uploadRename.addEventListener("change", e => handleRenameFiles(e.target.files));

// æ‹–æ‹½ä¸Šä¼ 
dropRename.addEventListener('dragover', e => {
  e.preventDefault();
  dropRename.classList.add('hover');
});

dropRename.addEventListener('dragleave', e => {
  e.preventDefault();
  dropRename.classList.remove('hover');
});

dropRename.addEventListener('drop', e => {
  e.preventDefault();
  dropRename.classList.remove('hover');
  handleRenameFiles(e.dataTransfer.files);
});

// ä¸‹è½½æ‰€æœ‰é‡å‘½ååçš„å›¾ç‰‡
downloadAllRenamed.addEventListener("click", () => {
  if (renameFiles.length === 0) return;

  const format = targetFormat.value;

  renameFiles.forEach((file, index) => {
    setTimeout(() => {
      const link = document.createElement("a");
      const newFileName = getNewFileName(file.name, format);
      link.download = newFileName;
      link.href = URL.createObjectURL(file);
      link.click();
    }, index * 200);
  });
});

// é‡ç½®æ‰¹é‡é‡å‘½åå·¥å…·
const resetRenameBtn = document.getElementById('resetRename');
resetRenameBtn.addEventListener('click', () => {
  renameFiles = [];
  uploadRename.value = '';
  renameImageGrid.style.display = 'none';
  renameGridContainer.innerHTML = '';
  downloadAllRenamed.style.display = 'none';
  targetFormat.value = 'png';
});

/* ======= å›¾ç‰‡å åŠ å·¥å…· ======= */
let backgroundImg = null;
let overlayImg = null;
let overlayX = 0;
let overlayY = 0;
let overlayWidth = 0;
let overlayHeight = 0;
let overlayOpacityValue = 1;
let isDragging = false;
let isResizing = false;
let dragStartX = 0;
let dragStartY = 0;
let resizeCorner = null;
let overlayAspectRatio = 1;

const uploadBackground = document.getElementById("uploadBackground");
const uploadOverlayImg = document.getElementById("uploadOverlay");
const dropBackground = document.getElementById("dropBackground");
const dropOverlayArea = document.getElementById("dropOverlay");
const overlayCanvas = document.getElementById("overlayCanvas");
const overlayPlaceholder = document.getElementById("overlayPlaceholder");
const ctx = overlayCanvas.getContext("2d");

const centerHorizontalBtn = document.getElementById("centerHorizontal");
const centerVerticalBtn = document.getElementById("centerVertical");
const centerBothBtn = document.getElementById("centerBoth");
const resetOverlayBtn = document.getElementById("resetOverlay");
const fitToBackgroundBtn = document.getElementById("fitToBackground");
const overlayOpacitySlider = document.getElementById("overlayOpacity");
const opacityValueSpan = document.getElementById("opacityValue");
const downloadOverlayBtn = document.getElementById("downloadOverlay");

// ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡
function handleBackgroundUpload(file) {
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      backgroundImg = img;
      initializeCanvas();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ä¸Šä¼ å åŠ å›¾ç‰‡
function handleOverlayUpload(file) {
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      overlayImg = img;
      overlayAspectRatio = img.width / img.height;
      initializeCanvas();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// åˆå§‹åŒ–ç”»å¸ƒ
function initializeCanvas() {
  if (!backgroundImg) return;

  // è®¾ç½®ç”»å¸ƒå¤§å°ä¸ºèƒŒæ™¯å›¾ç‰‡å¤§å°
  overlayCanvas.width = backgroundImg.width;
  overlayCanvas.height = backgroundImg.height;

  overlayCanvas.style.display = 'block';
  overlayPlaceholder.style.display = 'none';

  // å¦‚æœæœ‰å åŠ å›¾ç‰‡ï¼Œåˆå§‹åŒ–å…¶ä½ç½®å’Œå¤§å°
  if (overlayImg) {
    const scale = Math.min(
      (backgroundImg.width * 0.5) / overlayImg.width,
      (backgroundImg.height * 0.5) / overlayImg.height
    );
    overlayWidth = overlayImg.width * scale;
    overlayHeight = overlayImg.height * scale;
    overlayX = (backgroundImg.width - overlayWidth) / 2;
    overlayY = (backgroundImg.height - overlayHeight) / 2;

    // å¯ç”¨æ‰€æœ‰æ§åˆ¶æŒ‰é’®
    centerHorizontalBtn.disabled = false;
    centerVerticalBtn.disabled = false;
    centerBothBtn.disabled = false;
    resetOverlayBtn.disabled = false;
    fitToBackgroundBtn.disabled = false;
    overlayOpacitySlider.disabled = false;
    downloadOverlayBtn.disabled = false;
  }

  drawCanvas();
}

// ç»˜åˆ¶ç”»å¸ƒ
function drawCanvas() {
  if (!backgroundImg) return;

  ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

  // ç»˜åˆ¶èƒŒæ™¯å›¾ç‰‡
  ctx.drawImage(backgroundImg, 0, 0);

  // å¦‚æœæœ‰å åŠ å›¾ç‰‡ï¼Œç»˜åˆ¶å åŠ å›¾ç‰‡åŠæ§åˆ¶å…ƒç´ 
  if (overlayImg) {
    // ç»˜åˆ¶å åŠ å›¾ç‰‡
    ctx.globalAlpha = overlayOpacityValue;
    ctx.drawImage(overlayImg, overlayX, overlayY, overlayWidth, overlayHeight);
    ctx.globalAlpha = 1;

    // ç»˜åˆ¶å åŠ å›¾ç‰‡çš„è¾¹æ¡†å’Œæ§åˆ¶ç‚¹
    ctx.strokeStyle = '#0078d4';
    ctx.lineWidth = 2;
    ctx.strokeRect(overlayX, overlayY, overlayWidth, overlayHeight);

    // ç»˜åˆ¶å››ä¸ªè§’çš„æ§åˆ¶ç‚¹
    const corners = [
      { x: overlayX, y: overlayY, cursor: 'nw-resize' },
      { x: overlayX + overlayWidth, y: overlayY, cursor: 'ne-resize' },
      { x: overlayX, y: overlayY + overlayHeight, cursor: 'sw-resize' },
      { x: overlayX + overlayWidth, y: overlayY + overlayHeight, cursor: 'se-resize' }
    ];

    ctx.fillStyle = '#0078d4';
    corners.forEach(corner => {
      ctx.fillRect(corner.x - 5, corner.y - 5, 10, 10);
    });
  }
}

// è·å–é¼ æ ‡åœ¨ç”»å¸ƒä¸Šçš„ä½ç½®
function getMousePos(e) {
  const rect = overlayCanvas.getBoundingClientRect();
  const scaleX = overlayCanvas.width / rect.width;
  const scaleY = overlayCanvas.height / rect.height;

  return {
    x: (e.clientX - rect.left) * scaleX,
    y: (e.clientY - rect.top) * scaleY
  };
}

// æ£€æŸ¥æ˜¯å¦åœ¨æ§åˆ¶ç‚¹ä¸Š
function getResizeCorner(x, y) {
  const corners = [
    { x: overlayX, y: overlayY, name: 'nw' },
    { x: overlayX + overlayWidth, y: overlayY, name: 'ne' },
    { x: overlayX, y: overlayY + overlayHeight, name: 'sw' },
    { x: overlayX + overlayWidth, y: overlayY + overlayHeight, name: 'se' }
  ];

  for (let corner of corners) {
    const distance = Math.sqrt((x - corner.x) ** 2 + (y - corner.y) ** 2);
    if (distance < 10) {
      return corner.name;
    }
  }
  return null;
}

// é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
overlayCanvas.addEventListener('mousedown', (e) => {
  if (!backgroundImg || !overlayImg) return;

  const pos = getMousePos(e);
  resizeCorner = getResizeCorner(pos.x, pos.y);

  if (resizeCorner) {
    isResizing = true;
    dragStartX = pos.x;
    dragStartY = pos.y;
  } else if (pos.x >= overlayX && pos.x <= overlayX + overlayWidth &&
             pos.y >= overlayY && pos.y <= overlayY + overlayHeight) {
    isDragging = true;
    dragStartX = pos.x - overlayX;
    dragStartY = pos.y - overlayY;
  }
});

// é¼ æ ‡ç§»åŠ¨äº‹ä»¶
overlayCanvas.addEventListener('mousemove', (e) => {
  if (!backgroundImg || !overlayImg) return;

  const pos = getMousePos(e);

  if (isDragging) {
    overlayX = pos.x - dragStartX;
    overlayY = pos.y - dragStartY;

    // é™åˆ¶åœ¨ç”»å¸ƒèŒƒå›´å†…
    overlayX = Math.max(0, Math.min(overlayX, overlayCanvas.width - overlayWidth));
    overlayY = Math.max(0, Math.min(overlayY, overlayCanvas.height - overlayHeight));

    drawCanvas();
  } else if (isResizing) {
    const deltaX = pos.x - dragStartX;
    const deltaY = pos.y - dragStartY;

    let newWidth = overlayWidth;
    let newHeight = overlayHeight;
    let newX = overlayX;
    let newY = overlayY;

    // æ ¹æ®æ‹–æ‹½çš„è§’è®¡ç®—æ–°çš„å°ºå¯¸ï¼Œä¿æŒçºµæ¨ªæ¯”
    if (resizeCorner === 'se') {
      newWidth = overlayWidth + deltaX;
      newHeight = newWidth / overlayAspectRatio;
    } else if (resizeCorner === 'sw') {
      newWidth = overlayWidth - deltaX;
      newHeight = newWidth / overlayAspectRatio;
      newX = overlayX + deltaX;
    } else if (resizeCorner === 'ne') {
      newWidth = overlayWidth + deltaX;
      newHeight = newWidth / overlayAspectRatio;
      newY = overlayY - (newHeight - overlayHeight);
    } else if (resizeCorner === 'nw') {
      newWidth = overlayWidth - deltaX;
      newHeight = newWidth / overlayAspectRatio;
      newX = overlayX + deltaX;
      newY = overlayY - (newHeight - overlayHeight);
    }

    // ç¡®ä¿å°ºå¯¸ä¸å°äº10px
    if (newWidth > 10 && newHeight > 10) {
      overlayWidth = newWidth;
      overlayHeight = newHeight;
      overlayX = newX;
      overlayY = newY;
      dragStartX = pos.x;
      dragStartY = pos.y;
      drawCanvas();
    }
  } else {
    // æ›´æ–°é¼ æ ‡æ ·å¼
    const corner = getResizeCorner(pos.x, pos.y);
    if (corner) {
      overlayCanvas.style.cursor = corner + '-resize';
    } else if (pos.x >= overlayX && pos.x <= overlayX + overlayWidth &&
               pos.y >= overlayY && pos.y <= overlayY + overlayHeight) {
      overlayCanvas.style.cursor = 'move';
    } else {
      overlayCanvas.style.cursor = 'default';
    }
  }
});

// é¼ æ ‡é‡Šæ”¾äº‹ä»¶
overlayCanvas.addEventListener('mouseup', () => {
  isDragging = false;
  isResizing = false;
  resizeCorner = null;
});

overlayCanvas.addEventListener('mouseleave', () => {
  isDragging = false;
  isResizing = false;
  resizeCorner = null;
});

// æ°´å¹³å±…ä¸­
centerHorizontalBtn.addEventListener('click', () => {
  overlayX = (overlayCanvas.width - overlayWidth) / 2;
  drawCanvas();
});

// å‚ç›´å±…ä¸­
centerVerticalBtn.addEventListener('click', () => {
  overlayY = (overlayCanvas.height - overlayHeight) / 2;
  drawCanvas();
});

// å®Œå…¨å±…ä¸­
centerBothBtn.addEventListener('click', () => {
  overlayX = (overlayCanvas.width - overlayWidth) / 2;
  overlayY = (overlayCanvas.height - overlayHeight) / 2;
  drawCanvas();
});

// é‡ç½®ä½ç½®
resetOverlayBtn.addEventListener('click', () => {
  if (!backgroundImg || !overlayImg) return;

  const scale = Math.min(
    (backgroundImg.width * 0.5) / overlayImg.width,
    (backgroundImg.height * 0.5) / overlayImg.height
  );
  overlayWidth = overlayImg.width * scale;
  overlayHeight = overlayImg.height * scale;
  overlayX = (backgroundImg.width - overlayWidth) / 2;
  overlayY = (backgroundImg.height - overlayHeight) / 2;

  drawCanvas();
});

// é€‚åº”èƒŒæ™¯
fitToBackgroundBtn.addEventListener('click', () => {
  if (!backgroundImg || !overlayImg) return;

  const scale = Math.min(
    backgroundImg.width / overlayImg.width,
    backgroundImg.height / overlayImg.height
  );
  overlayWidth = overlayImg.width * scale;
  overlayHeight = overlayImg.height * scale;
  overlayX = (backgroundImg.width - overlayWidth) / 2;
  overlayY = (backgroundImg.height - overlayHeight) / 2;

  drawCanvas();
});

// ä¸é€æ˜åº¦è°ƒæ•´
overlayOpacitySlider.addEventListener('input', () => {
  overlayOpacityValue = overlayOpacitySlider.value / 100;
  opacityValueSpan.textContent = overlayOpacitySlider.value + '%';
  drawCanvas();
});

// ä¸‹è½½åˆæˆå›¾ç‰‡
downloadOverlayBtn.addEventListener('click', () => {
  if (!backgroundImg || !overlayImg) return;

  // åˆ›å»ºæœ€ç»ˆåˆæˆçš„canvas
  const finalCanvas = document.createElement('canvas');
  finalCanvas.width = overlayCanvas.width;
  finalCanvas.height = overlayCanvas.height;
  const finalCtx = finalCanvas.getContext('2d');

  // ç»˜åˆ¶èƒŒæ™¯
  finalCtx.drawImage(backgroundImg, 0, 0);

  // ç»˜åˆ¶å åŠ å›¾ç‰‡
  finalCtx.globalAlpha = overlayOpacityValue;
  finalCtx.drawImage(overlayImg, overlayX, overlayY, overlayWidth, overlayHeight);
  finalCtx.globalAlpha = 1;

  // ä¸‹è½½
  finalCanvas.toBlob(blob => {
    const link = document.createElement('a');
    link.download = 'overlay_result.png';
    link.href = URL.createObjectURL(blob);
    link.click();
  });
});

// æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
uploadBackground.addEventListener('change', e => handleBackgroundUpload(e.target.files[0]));
uploadOverlayImg.addEventListener('change', e => handleOverlayUpload(e.target.files[0]));

// æ‹–æ‹½ä¸Šä¼  - èƒŒæ™¯å›¾ç‰‡
dropBackground.addEventListener('dragover', e => {
  e.preventDefault();
  dropBackground.classList.add('hover');
});

dropBackground.addEventListener('dragleave', e => {
  e.preventDefault();
  dropBackground.classList.remove('hover');
});

dropBackground.addEventListener('drop', e => {
  e.preventDefault();
  dropBackground.classList.remove('hover');
  handleBackgroundUpload(e.dataTransfer.files[0]);
});

// æ‹–æ‹½ä¸Šä¼  - å åŠ å›¾ç‰‡
dropOverlayArea.addEventListener('dragover', e => {
  e.preventDefault();
  dropOverlayArea.classList.add('hover');
});

dropOverlayArea.addEventListener('dragleave', e => {
  e.preventDefault();
  dropOverlayArea.classList.remove('hover');
});

dropOverlayArea.addEventListener('drop', e => {
  e.preventDefault();
  dropOverlayArea.classList.remove('hover');
  handleOverlayUpload(e.dataTransfer.files[0]);
});

// é‡ç½®å›¾ç‰‡å åŠ å·¥å…·
const resetOverlayToolBtn = document.getElementById('resetOverlayTool');
resetOverlayToolBtn.addEventListener('click', () => {
  // æ¸…ç©ºå›¾ç‰‡
  backgroundImg = null;
  overlayImg = null;
  overlayX = 0;
  overlayY = 0;
  overlayWidth = 0;
  overlayHeight = 0;
  overlayOpacityValue = 1;
  isDragging = false;
  isResizing = false;
  resizeCorner = null;
  overlayAspectRatio = 1;

  // æ¸…ç©ºè¾“å…¥
  uploadBackground.value = '';
  uploadOverlayImg.value = '';

  // æ¸…ç©ºç”»å¸ƒ
  ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
  overlayCanvas.style.display = 'none';
  overlayPlaceholder.style.display = 'block';

  // ç¦ç”¨æŒ‰é’®
  centerHorizontalBtn.disabled = true;
  centerVerticalBtn.disabled = true;
  centerBothBtn.disabled = true;
  resetOverlayBtn.disabled = true;
  fitToBackgroundBtn.disabled = true;
  overlayOpacitySlider.disabled = true;
  downloadOverlayBtn.disabled = true;

  // é‡ç½®ä¸é€æ˜åº¦
  overlayOpacitySlider.value = 100;
  opacityValueSpan.textContent = '100%';
});
</script>
</body>
</html>
