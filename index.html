<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å›¾ç‰‡å¤„ç†å·¥å…·</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }

  .header {
    text-align: center;
    margin-bottom: 20px;
  }

  .header h1 {
    color: #333;
    margin: 0;
    font-size: 2.5em;
    font-weight: 300;
  }

  .header p {
    color: #666;
    margin: 10px 0 0 0;
    font-size: 1.1em;
  }

  .tabs {
    display: flex;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 20px;
  }

  .tab {
    padding: 15px 30px;
    background: #f8f9fa;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    color: #666;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
  }

  .tab.active {
    background: #fff;
    color: #0078d4;
    border-bottom-color: #0078d4;
  }

  .tab:hover {
    background: #e9ecef;
    color: #0078d4;
  }

  .tab-content {
    display: none;
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 8px 18px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 600px;
    text-align: center;
  }

  .tab-content.active {
    display: block;
  }

  h2 {
    color: #333;
    margin-bottom: 20px;
    font-size: 1.8em;
    font-weight: 400;
  }

  .drop-area {
    display: flex;
    padding: 30px;
    border: 2px dashed #bbb;
    border-radius: 12px;
    background: #fafafa;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 20px;
    justify-content: center;
    align-items: center;
    font-size: 16px;
    color: #666;
  }

  .drop-area.hover {
    border-color: #0078d4;
    background: #f0f8ff;
    color: #0078d4;
  }

  .img-container {
    width: 100%;
    max-height: 400px;
    margin: 20px 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    background: #fafafa;
  }

  .img-container img,
  .img-container canvas {
    max-width: 100%;
    max-height: 100%;
    display: block;
    margin: auto;
  }

  input[type="number"], input[type="text"] {
    width: 100px;
    padding: 8px;
    margin: 0 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    text-align: center;
    font-size: 14px;
    transition: border-color 0.3s ease;
  }

  input[type="number"]:focus, input[type="text"]:focus {
    outline: none;
    border-color: #0078d4;
  }

  .controls {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
  }

  .control-group {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .control-group label {
    font-weight: 500;
    color: #555;
  }

  button {
    padding: 10px 20px;
    margin: 8px;
    border: none;
    border-radius: 8px;
    background-color: #0078d4;
    color: #fff;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  button:hover {
    background-color: #005a9e;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  input[type="file"] {
    display: none;
  }

  .batch-info {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    color: #1976d2;
    font-size: 14px;
  }

  .color-preview {
    display: inline-block;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin: 0 5px;
    border: 2px solid #ddd;
    vertical-align: middle;
  }
</style>
</head>
<body>
  <div class="header">
    <h1>å›¾ç‰‡å¤„ç†å·¥å…·</h1>
    <p>ä¸“ä¸šçš„åœ¨çº¿å›¾ç‰‡ç¼–è¾‘å·¥å…·ï¼Œæ”¯æŒè£å‰ªã€é¢œè‰²æ›¿æ¢ç­‰åŠŸèƒ½</p>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="crop">å›¾ç‰‡è£å‰ª</button>
    <button class="tab" data-tab="replace">é¢œè‰²æ›¿æ¢</button>
  </div>

  <!-- è£å‰ªå·¥å…· -->
  <div class="tab-content active" id="crop">
    <h2>å›¾ç‰‡è£å‰ªå·¥å…·</h2>
    <label class="drop-area" id="dropCrop">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡
      <input type="file" id="uploadCrop" accept="image/*">
    </label>

    <div class="img-container">
      <img id="imageCrop" alt="è¯·ä¸Šä¼ å›¾ç‰‡">
    </div>

    <div class="controls">
      <div class="control-group">
        <label>X:</label>
        <input type="number" id="posX" value="55">
      </div>
      <div class="control-group">
        <label>Y:</label>
        <input type="number" id="posY" value="0">
      </div>
      <div class="control-group">
        <label>W:</label>
        <input type="number" id="width" value="341">
      </div>
      <div class="control-group">
        <label>H:</label>
        <input type="number" id="height" value="65">
      </div>
      <button id="applyCrop">åº”ç”¨è£å‰ª</button>
    </div>

    <div style="margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
      <button id="preset1" style="background: #6c757d;">é¢„è®¾1 (55,0,341,65)</button>
      <button id="preset2" style="background: #6c757d;">é¢„è®¾2 (65,0,411,65)</button>
    </div>

    <div id="customPresets" style="margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
      <!-- è‡ªå®šä¹‰é¢„è®¾æŒ‰é’®å°†åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
    </div>

    <div style="margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
      <button id="savePreset" style="background: #28a745;">ä¿å­˜å½“å‰å€¼ä¸ºé¢„è®¾</button>
      <button id="managePresets" style="background: #17a2b8;">ç®¡ç†é¢„è®¾</button>
    </div>

    <button id="downloadCrop">ä¸‹è½½è£å‰ªåçš„å›¾ç‰‡</button>
  </div>

  <!-- é¢œè‰²æ›¿æ¢å·¥å…· -->
  <div class="tab-content" id="replace">
    <h2>å›¾ç‰‡é¢œè‰²æ›¿æ¢å·¥å…·</h2>
    <div class="batch-info">
      ğŸ’¡ æ”¯æŒæ‰¹é‡å¤„ç†ï¼šä¸Šä¼ å¤šå¼ å›¾ç‰‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºæ¯å¼ å›¾ç‰‡åº”ç”¨ç›¸åŒçš„é¢œè‰²æ›¿æ¢è®¾ç½®
    </div>

    <label class="drop-area" id="dropReplace">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
      <input type="file" id="uploadReplace" accept="image/*" multiple>
    </label>

    <div id="imageGrid" style="display: none; margin: 15px 0;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h4 style="margin: 0; color: #333;">å›¾ç‰‡é¢„è§ˆ</h4>
        <span id="uploadCount" style="background: #0078d4; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 500;"></span>
      </div>
      <div id="gridContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>åŸé¢œè‰²:</label>
        <span class="color-preview" id="fromColorPreview" style="background-color: #000000;"></span>
        <input type="text" id="fromColor" value="#000000">
      </div>
      <div class="control-group">
        <label>ç›®æ ‡é¢œè‰²:</label>
        <span class="color-preview" id="toColorPreview" style="background-color: #ff0000;"></span>
        <input type="text" id="toColor" value="#ff0000">
      </div>
      <div class="control-group">
        <label>å®¹å·®:</label>
        <input type="number" id="tolerance" value="999" min="0" max="441">
      </div>
    </div>

    <button id="downloadReplace">ä¸‹è½½ä¿®æ”¹åçš„å›¾ç‰‡</button>
    <button id="downloadAllReplace" style="display: none;">ä¸‹è½½æ‰€æœ‰å›¾ç‰‡</button>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
/* ======= æ ‡ç­¾é¡µåˆ‡æ¢ ======= */
document.addEventListener('DOMContentLoaded', function() {
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));

      // æ·»åŠ å½“å‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
      tab.classList.add('active');
      const targetTab = tab.getAttribute('data-tab');
      document.getElementById(targetTab).classList.add('active');
    });
  });
});

/* ======= è£å‰ªå·¥å…· ======= */
let cropper, cropFileName = "cropped.png";
const imageCrop = document.getElementById('imageCrop');
const uploadCrop = document.getElementById('uploadCrop');
const downloadCrop = document.getElementById('downloadCrop');
const applyCrop = document.getElementById('applyCrop');
const preset1Btn = document.getElementById('preset1');
const preset2Btn = document.getElementById('preset2');
const savePresetBtn = document.getElementById('savePreset');
const managePresetsBtn = document.getElementById('managePresets');
const customPresetsContainer = document.getElementById('customPresets');

const posX = document.getElementById('posX');
const posY = document.getElementById('posY');
const width = document.getElementById('width');
const height = document.getElementById('height');

// å›ºå®šé¢„è®¾å€¼
const CROP_PRESETS = {
  preset1: {
    x: 55,
    y: 0,
    width: 341,
    height: 65
  },
  preset2: {
    x: 65,
    y: 0,
    width: 411,
    height: 65
  }
};

// é»˜è®¤ä½¿ç”¨é¢„è®¾1
const DEFAULT_CROP_VALUES = CROP_PRESETS.preset1;

// localStorage key
const CUSTOM_PRESETS_KEY = 'cropCustomPresets';

// ä»localStorageåŠ è½½è‡ªå®šä¹‰é¢„è®¾
function loadCustomPresets() {
  const saved = localStorage.getItem(CUSTOM_PRESETS_KEY);
  return saved ? JSON.parse(saved) : [];
}

// ä¿å­˜è‡ªå®šä¹‰é¢„è®¾åˆ°localStorage
function saveCustomPresets(presets) {
  localStorage.setItem(CUSTOM_PRESETS_KEY, JSON.stringify(presets));
}

// æ¸²æŸ“è‡ªå®šä¹‰é¢„è®¾æŒ‰é’®
function renderCustomPresets() {
  const customPresets = loadCustomPresets();
  customPresetsContainer.innerHTML = '';

  if (customPresets.length === 0) {
    customPresetsContainer.style.display = 'none';
    return;
  }

  customPresetsContainer.style.display = 'flex';

  customPresets.forEach((preset, index) => {
    const btn = document.createElement('button');
    btn.style.cssText = 'background: #fd7e14; position: relative; padding-right: 35px;';
    btn.innerHTML = `${preset.name || 'è‡ªå®šä¹‰' + (index + 1)} (${preset.x},${preset.y},${preset.width},${preset.height})`;

    btn.addEventListener('click', () => {
      applyPreset(preset);
    });

    customPresetsContainer.appendChild(btn);
  });
}

function handleCropFile(file){
  if (!file) return;
  cropFileName = file.name.replace(/\.[^/.]+$/, "") + ".png";
  const url = URL.createObjectURL(file);
  imageCrop.src = url;

  if (cropper) cropper.destroy();
  cropper = new Cropper(imageCrop, {
    aspectRatio: NaN,
    viewMode: 1,
    autoCropArea: 0.3,
    crop(event) {
      posX.value = Math.round(event.detail.x);
      posY.value = Math.round(event.detail.y);
      width.value = Math.round(event.detail.width);
      height.value = Math.round(event.detail.height);
    },
    ready() {
      cropper.setData(DEFAULT_CROP_VALUES);
    }
  });
}

uploadCrop.addEventListener('change', e => handleCropFile(e.target.files[0]));

// æ‹–æ‹½ä¸Šä¼ 
const dropCrop = document.getElementById('dropCrop');
dropCrop.addEventListener('dragover', e => { e.preventDefault(); dropCrop.classList.add('hover'); });
dropCrop.addEventListener('dragleave', e => { e.preventDefault(); dropCrop.classList.remove('hover'); });
dropCrop.addEventListener('drop', e => {
  e.preventDefault();
  dropCrop.classList.remove('hover');
  const file = e.dataTransfer.files[0];
  handleCropFile(file);
});

applyCrop.addEventListener('click', () => {
  if (!cropper) {
    alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡");
    return;
  }

  const x = parseInt(posX.value) || 0;
  const y = parseInt(posY.value) || 0;
  const w = parseInt(width.value) || 100;
  const h = parseInt(height.value) || 100;

  cropper.setData({ x, y, width: w, height: h });
});

downloadCrop.addEventListener('click', () => {
  if (!cropper) return alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡");
  const canvas = cropper.getCroppedCanvas();
  canvas.toBlob(blob => {
    const link = document.createElement('a');
    link.download = cropFileName;
    link.href = URL.createObjectURL(blob);
    link.click();
  });
});

// åº”ç”¨é¢„è®¾å€¼çš„é€šç”¨å‡½æ•°
function applyPreset(presetValues) {
  // æ›´æ–°è¾“å…¥æ¡†å€¼
  posX.value = presetValues.x;
  posY.value = presetValues.y;
  width.value = presetValues.width;
  height.value = presetValues.height;

  // å¦‚æœæœ‰å›¾ç‰‡ï¼Œåº”ç”¨è£å‰ª
  if (cropper) {
    cropper.setData(presetValues);
  }
}

// é¢„è®¾1æŒ‰é’®
preset1Btn.addEventListener('click', () => {
  applyPreset(CROP_PRESETS.preset1);
});

// é¢„è®¾2æŒ‰é’®
preset2Btn.addEventListener('click', () => {
  applyPreset(CROP_PRESETS.preset2);
});

// ä¿å­˜å½“å‰å€¼ä¸ºé¢„è®¾
savePresetBtn.addEventListener('click', () => {
  const name = prompt('è¯·è¾“å…¥é¢„è®¾åç§°ï¼š', 'æˆ‘çš„é¢„è®¾');
  if (!name) return;

  const newPreset = {
    name: name,
    x: parseInt(posX.value) || 0,
    y: parseInt(posY.value) || 0,
    width: parseInt(width.value) || 100,
    height: parseInt(height.value) || 100
  };

  const customPresets = loadCustomPresets();
  customPresets.push(newPreset);
  saveCustomPresets(customPresets);
  renderCustomPresets();

  alert('é¢„è®¾å·²ä¿å­˜ï¼');
});

// ç®¡ç†é¢„è®¾
managePresetsBtn.addEventListener('click', () => {
  const customPresets = loadCustomPresets();

  if (customPresets.length === 0) {
    alert('æš‚æ— è‡ªå®šä¹‰é¢„è®¾');
    return;
  }

  let message = 'å½“å‰è‡ªå®šä¹‰é¢„è®¾åˆ—è¡¨ï¼š\n\n';
  customPresets.forEach((preset, index) => {
    message += `${index + 1}. ${preset.name} (${preset.x},${preset.y},${preset.width},${preset.height})\n`;
  });
  message += '\nè¾“å…¥è¦åˆ é™¤çš„é¢„è®¾ç¼–å·ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰ï¼Œæˆ–ç‚¹å‡»å–æ¶ˆè¿”å›ï¼š';

  const input = prompt(message);
  if (!input) return;

  const indexesToDelete = input.split(',').map(i => parseInt(i.trim()) - 1).filter(i => i >= 0 && i < customPresets.length);

  if (indexesToDelete.length === 0) {
    alert('æ²¡æœ‰æœ‰æ•ˆçš„ç¼–å·');
    return;
  }

  // ä»åå¾€å‰åˆ é™¤ï¼Œé¿å…ç´¢å¼•å˜åŒ–
  indexesToDelete.sort((a, b) => b - a).forEach(index => {
    customPresets.splice(index, 1);
  });

  saveCustomPresets(customPresets);
  renderCustomPresets();

  alert(`å·²åˆ é™¤ ${indexesToDelete.length} ä¸ªé¢„è®¾`);
});

// é¡µé¢åŠ è½½æ—¶æ¸²æŸ“è‡ªå®šä¹‰é¢„è®¾
renderCustomPresets();

/* ======= é¢œè‰²æ›¿æ¢å·¥å…· ======= */
let uploadedFiles = [];
let currentFileIndex = 0;
let processedImages = [];

const uploadReplace = document.getElementById("uploadReplace");
const fromColor = document.getElementById("fromColor");
const toColor = document.getElementById("toColor");
const toleranceInput = document.getElementById("tolerance");
const downloadReplace = document.getElementById("downloadReplace");
const downloadAllReplace = document.getElementById("downloadAllReplace");
const fromColorPreview = document.getElementById("fromColorPreview");
const toColorPreview = document.getElementById("toColorPreview");
const imageGrid = document.getElementById("imageGrid");
const gridContainer = document.getElementById("gridContainer");
const uploadCount = document.getElementById("uploadCount");

// é¢œè‰²é¢„è§ˆæ›´æ–°
function updateColorPreviews() {
  fromColorPreview.style.backgroundColor = fromColor.value;
  toColorPreview.style.backgroundColor = toColor.value;
}

fromColor.addEventListener('input', updateColorPreviews);
toColor.addEventListener('input', updateColorPreviews);

// å®æ—¶é¢œè‰²æ›¿æ¢ - å¤„ç†æ‰€æœ‰å›¾ç‰‡
function applyColorReplace() {
  if (uploadedFiles.length === 0) return;

  // ä¸ºæ¯å¼ å›¾ç‰‡åˆ›å»ºå¤„ç†åçš„canvas
  uploadedFiles.forEach((file, index) => {
    const img = new Image();
    img.onload = () => {
      // åˆ›å»ºä¸´æ—¶canvasè¿›è¡Œå¤„ç†
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');

      tempCanvas.width = img.width;
      tempCanvas.height = img.height;
      tempCtx.drawImage(img, 0, 0);

      // è·å–å›¾åƒæ•°æ®
      const imgData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
      const data = imgData.data;

      // é¢œè‰²æ›¿æ¢å¤„ç†
      const [fr, fg, fb] = hexToRgb(fromColor.value);
      const [tr, tg, tb] = hexToRgb(toColor.value);
      const tolerance = parseInt(toleranceInput.value) || 0;

      for (let i = 0; i < data.length; i += 4) {
        const dr = data[i] - fr;
        const dg = data[i+1] - fg;
        const db = data[i+2] - fb;
        const dist = Math.sqrt(dr*dr + dg*dg + db*db);

        if (dist <= tolerance) {
          data[i] = tr;
          data[i+1] = tg;
          data[i+2] = tb;
        }
      }

      // åº”ç”¨å¤„ç†åçš„å›¾åƒæ•°æ®
      tempCtx.putImageData(imgData, 0, 0);

      // ä¿å­˜å¤„ç†åçš„å›¾ç‰‡æ•°æ®
      processedImages[index] = tempCanvas.toDataURL("image/png");

      // æ›´æ–°ç½‘æ ¼ä¸­å¯¹åº”å›¾ç‰‡çš„æ˜¾ç¤º
      updateGridImage(index, processedImages[index]);
    };

    img.onerror = () => {
      console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', file.name);
    };

    const url = URL.createObjectURL(file);
    img.src = url;
  });
}

// æ›´æ–°ç½‘æ ¼ä¸­æŒ‡å®šå›¾ç‰‡çš„æ˜¾ç¤º
function updateGridImage(index, processedImageData) {
  const gridItems = gridContainer.children;
  if (gridItems[index]) {
    const img = gridItems[index].querySelector('img');
    if (img && processedImageData) {
      img.src = processedImageData;
    }
  }
}

// é˜²æŠ–å‡½æ•°
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// åˆ›å»ºé˜²æŠ–çš„é¢œè‰²æ›¿æ¢å‡½æ•°
const debouncedApplyColorReplace = debounce(applyColorReplace, 100);

// ç›‘å¬é¢œè‰²å’Œå®¹å·®å˜åŒ–ï¼Œå®æ—¶åº”ç”¨æ›¿æ¢
fromColor.addEventListener('input', debouncedApplyColorReplace);
toColor.addEventListener('input', debouncedApplyColorReplace);
toleranceInput.addEventListener('input', debouncedApplyColorReplace);

function handleReplaceFiles(files) {
  console.log('ä¸Šä¼ æ–‡ä»¶æ•°é‡:', files.length);

  if (!files || files.length === 0) {
    console.log('æ²¡æœ‰æ–‡ä»¶ä¸Šä¼ ');
    return;
  }

  // éªŒè¯æ–‡ä»¶ç±»å‹
  const validFiles = Array.from(files).filter(file => {
    const isValid = file.type.startsWith('image/');
    if (!isValid) {
      console.warn('æ— æ•ˆæ–‡ä»¶ç±»å‹:', file.name, file.type);
    }
    return isValid;
  });

  if (validFiles.length === 0) {
    alert('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
    return;
  }

  uploadedFiles = validFiles;
  processedImages = new Array(validFiles.length);
  currentFileIndex = 0;

  console.log('æœ‰æ•ˆæ–‡ä»¶æ•°é‡:', uploadedFiles.length);

  // æ˜¾ç¤ºå›¾ç‰‡ç½‘æ ¼
  imageGrid.style.display = 'block';
  updateImageGrid();

  if (validFiles.length > 1) {
    downloadAllReplace.style.display = 'inline-block';
  } else {
    downloadAllReplace.style.display = 'none';
  }

  applyColorReplace();
}

function updateImageGrid() {
  // æ›´æ–°ä¸Šä¼ æ€»æ•°
  uploadCount.textContent = `å·²ä¸Šä¼  ${uploadedFiles.length} å¼ `;

  gridContainer.innerHTML = '';

  uploadedFiles.forEach((file, index) => {
    const gridItem = document.createElement('div');
    gridItem.style.cssText = `
      position: relative;
      border: 2px solid ${index === currentFileIndex ? '#0078d4' : '#dee2e6'};
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8f9fa;
    `;

    const img = document.createElement('img');
    img.style.cssText = `
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    `;

    const fileName = document.createElement('div');
    fileName.style.cssText = `
      padding: 8px;
      font-size: 12px;
      color: #666;
      text-align: center;
      background: rgba(255,255,255,0.9);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    `;
    fileName.textContent = file.name;

    const statusIndicator = document.createElement('div');
    statusIndicator.style.cssText = `
      position: absolute;
      top: 5px;
      right: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: ${processedImages[index] ? '#28a745' : '#ffc107'};
      border: 2px solid #fff;
    `;

    gridItem.appendChild(img);
    gridItem.appendChild(fileName);
    gridItem.appendChild(statusIndicator);

    // åŠ è½½å›¾ç‰‡ - å¦‚æœå·²å¤„ç†åˆ™æ˜¾ç¤ºå¤„ç†åçš„å›¾ç‰‡ï¼Œå¦åˆ™æ˜¾ç¤ºåŸå›¾
    if (processedImages[index]) {
      img.src = processedImages[index];
    } else {
      const url = URL.createObjectURL(file);
      img.src = url;
    }

    // ç‚¹å‡»åˆ‡æ¢å½“å‰é€‰ä¸­å›¾ç‰‡
    gridItem.addEventListener('click', () => {
      currentFileIndex = index;
      updateImageGrid();
    });

    // æ‚¬åœæ•ˆæœ
    gridItem.addEventListener('mouseenter', () => {
      if (index !== currentFileIndex) {
        gridItem.style.borderColor = '#0078d4';
        gridItem.style.transform = 'scale(1.02)';
      }
    });

    gridItem.addEventListener('mouseleave', () => {
      if (index !== currentFileIndex) {
        gridItem.style.borderColor = '#dee2e6';
        gridItem.style.transform = 'scale(1)';
      }
    });

    gridContainer.appendChild(gridItem);
  });
}

uploadReplace.addEventListener("change", e => handleReplaceFiles(e.target.files));

const dropReplace = document.getElementById('dropReplace');
dropReplace.addEventListener('dragover', e => { e.preventDefault(); dropReplace.classList.add('hover'); });
dropReplace.addEventListener('dragleave', e => { e.preventDefault(); dropReplace.classList.remove('hover'); });
dropReplace.addEventListener('drop', e => {
  e.preventDefault();
  dropReplace.classList.remove('hover');
  handleReplaceFiles(e.dataTransfer.files);
});

function hexToRgb(hex) {
  hex = hex.replace("#", "");
  let bigint = parseInt(hex, 16);
  return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
}

downloadReplace.addEventListener("click", () => {
  if (uploadedFiles.length === 0) {
    alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡");
    return;
  }

  if (!processedImages[currentFileIndex]) {
    alert("å›¾ç‰‡å¤„ç†ä¸­ï¼Œè¯·ç¨å€™");
    return;
  }

  const link = document.createElement("a");
  const fileName = uploadedFiles[currentFileIndex].name.replace(/\.[^/.]+$/, "") + "_replaced.png";
  link.download = fileName;
  link.href = processedImages[currentFileIndex];
  link.click();
});

downloadAllReplace.addEventListener("click", () => {
  if (uploadedFiles.length === 0) {
    alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡");
    return;
  }

  // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å›¾ç‰‡éƒ½å·²å¤„ç†
  const allProcessed = processedImages.every(img => img !== undefined);
  if (!allProcessed) {
    alert("éƒ¨åˆ†å›¾ç‰‡è¿˜åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™");
    return;
  }

  // æ‰¹é‡ä¸‹è½½æ‰€æœ‰å›¾ç‰‡
  uploadedFiles.forEach((file, index) => {
    setTimeout(() => {
      const link = document.createElement("a");
      const fileName = file.name.replace(/\.[^/.]+$/, "") + "_replaced.png";
      link.download = fileName;
      link.href = processedImages[index];
      link.click();
    }, index * 200); // å¢åŠ å»¶è¿Ÿé¿å…æµè§ˆå™¨é˜»æ­¢
  });

  alert(`å¼€å§‹ä¸‹è½½ ${uploadedFiles.length} å¼ å›¾ç‰‡`);
});
</script>
</body>
</html>
