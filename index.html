<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>图片处理工具</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }

  .header {
    text-align: center;
    margin-bottom: 20px;
  }

  .header h1 {
    color: #333;
    margin: 0;
    font-size: 2.5em;
    font-weight: 300;
  }

  .header p {
    color: #666;
    margin: 10px 0 0 0;
    font-size: 1.1em;
  }

  .tabs {
    display: flex;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 20px;
  }

  .tab {
    padding: 15px 30px;
    background: #f8f9fa;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    color: #666;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
  }

  .tab.active {
    background: #fff;
    color: #0078d4;
    border-bottom-color: #0078d4;
  }

  .tab:hover {
    background: #e9ecef;
    color: #0078d4;
  }

  .tab-content {
    display: none;
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 8px 18px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 600px;
    text-align: center;
  }

  .tab-content.active {
    display: block;
  }

  h2 {
    color: #333;
    margin-bottom: 20px;
    font-size: 1.8em;
    font-weight: 400;
  }

  .drop-area {
    display: flex;
    padding: 30px;
    border: 2px dashed #bbb;
    border-radius: 12px;
    background: #fafafa;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 20px;
    justify-content: center;
    align-items: center;
    font-size: 16px;
    color: #666;
  }

  .drop-area.hover {
    border-color: #0078d4;
    background: #f0f8ff;
    color: #0078d4;
  }

  .img-container {
    width: 100%;
    max-height: 400px;
    margin: 20px 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    background: #fafafa;
  }

  .img-container img,
  .img-container canvas {
    max-width: 100%;
    max-height: 100%;
    display: block;
    margin: auto;
  }

  input[type="number"], input[type="text"] {
    width: 100px;
    padding: 8px;
    margin: 0 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    text-align: center;
    font-size: 14px;
    transition: border-color 0.3s ease;
  }

  input[type="number"]:focus, input[type="text"]:focus {
    outline: none;
    border-color: #0078d4;
  }

  .controls {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
  }

  .control-group {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .control-group label {
    font-weight: 500;
    color: #555;
  }

  button {
    padding: 10px 20px;
    margin: 8px;
    border: none;
    border-radius: 8px;
    background-color: #0078d4;
    color: #fff;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  button:hover {
    background-color: #005a9e;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  input[type="file"] {
    display: none;
  }

  .batch-info {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    color: #1976d2;
    font-size: 14px;
  }

  .color-preview {
    display: inline-block;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin: 0 5px;
    border: 2px solid #ddd;
    vertical-align: middle;
  }
</style>
</head>
<body>
  <div class="header">
    <h1>图片处理工具</h1>
    <p>专业的在线图片编辑工具，支持裁剪、颜色替换、批量重命名、图片叠加等功能</p>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="crop">图片裁剪</button>
    <button class="tab" data-tab="replace">颜色替换</button>
    <button class="tab" data-tab="rename">批量重命名</button>
    <button class="tab" data-tab="overlay">图片叠加</button>
  </div>

  <!-- 裁剪工具 -->
  <div class="tab-content active" id="crop">
    <h2>图片裁剪工具</h2>
    <label class="drop-area" id="dropCrop">拖拽或点击上传图片
      <input type="file" id="uploadCrop" accept="image/*">
    </label>

    <div class="img-container">
      <img id="imageCrop" alt="请上传图片">
    </div>

    <div class="controls">
      <div class="control-group">
        <label>X:</label>
        <input type="number" id="posX" value="55">
      </div>
      <div class="control-group">
        <label>Y:</label>
        <input type="number" id="posY" value="0">
      </div>
      <div class="control-group">
        <label>W:</label>
        <input type="number" id="width" value="341">
      </div>
      <div class="control-group">
        <label>H:</label>
        <input type="number" id="height" value="65">
      </div>
      <button id="applyCrop">应用裁剪</button>
    </div>

    <div style="margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
      <button id="preset1" style="background: #6c757d;">预设1 (55,0,341,65)</button>
      <button id="preset2" style="background: #6c757d;">预设2 (65,0,411,65)</button>
    </div>

    <div id="customPresets" style="margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
      <!-- 自定义预设按钮将动态插入到这里 -->
    </div>

    <div style="margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
      <button id="savePreset" style="background: #28a745;">保存当前值为预设</button>
      <button id="managePresets" style="background: #17a2b8;">管理预设</button>
    </div>

    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
    <button id="downloadCrop">下载裁剪后的图片</button>
      <button id="resetCrop" style="background: #dc3545;">重置工具</button>
    </div>
  </div>

  <!-- 颜色替换工具 -->
  <div class="tab-content" id="replace">
    <h2>图片颜色替换工具</h2>
    <div class="batch-info">
      💡 支持批量处理：上传多张图片，系统会自动为每张图片应用相同的颜色替换设置<br>
      🎨 支持多种颜色格式：十六进制（#ff0000）、命名颜色（red、blue）、RGB（rgb(255,0,0)）
    </div>

    <label class="drop-area" id="dropReplace">拖拽或点击上传图片（支持多选）
      <input type="file" id="uploadReplace" accept="image/*" multiple>
    </label>

    <div id="imageGrid" style="display: none; margin: 15px 0;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h4 style="margin: 0; color: #333;">图片预览</h4>
        <span id="uploadCount" style="background: #0078d4; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 500;"></span>
      </div>
      <div id="gridContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>原颜色:</label>
        <span class="color-preview" id="fromColorPreview" style="background-color: #000000;"></span>
        <input type="text" id="fromColor" value="#000000" placeholder="如: #000000 或 black">
      </div>
      <div class="control-group">
        <label>目标颜色:</label>
        <span class="color-preview" id="toColorPreview" style="background-color: #ff0000;"></span>
        <input type="text" id="toColor" value="#ff0000" placeholder="如: #ff0000 或 red">
      </div>
      <div class="control-group">
        <label>容差:</label>
        <input type="number" id="tolerance" value="999" min="0" max="441">
      </div>
    </div>

    <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
    <button id="downloadReplace">下载修改后的图片</button>
    <button id="downloadAllReplace" style="display: none;">下载所有图片</button>
      <button id="resetReplace" style="background: #dc3545;">重置工具</button>
    </div>
  </div>

  <!-- 批量重命名工具 -->
  <div class="tab-content" id="rename">
    <h2>批量重命名图片后缀</h2>
    <div class="batch-info">
      ✏️ 批量重命名：上传多张图片，一键修改所有图片的文件后缀名<br>
      📦 预设后缀：.png、.jpg、.webp、.avif、.bmp、.gif 等常用格式<br>
      ⚡ 注意：仅修改文件名后缀，不进行实际格式转换
    </div>

    <label class="drop-area" id="dropRename">拖拽或点击上传图片（支持多选）
      <input type="file" id="uploadRename" accept="image/*" multiple>
    </label>

    <div id="renameImageGrid" style="display: none; margin: 15px 0;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h4 style="margin: 0; color: #333;">图片列表</h4>
        <span id="renameUploadCount" style="background: #0078d4; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 500;"></span>
      </div>
      <div id="renameGridContainer" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px;"></div>
    </div>

    <div class="controls" style="flex-direction: column; gap: 20px; margin-top: 20px;">
      <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
        <button class="format-btn" data-format="png" style="background: #6f42c1;">.png</button>
        <button class="format-btn" data-format="jpg" style="background: #e83e8c;">.jpg</button>
        <button class="format-btn" data-format="jpeg" style="background: #d63384;">.jpeg</button>
        <button class="format-btn" data-format="webp" style="background: #20c997;">.webp</button>
        <button class="format-btn" data-format="avif" style="background: #fd7e14;">.avif</button>
        <button class="format-btn" data-format="bmp" style="background: #6c757d;">.bmp</button>
        <button class="format-btn" data-format="gif" style="background: #17a2b8;">.gif</button>
      </div>

      <div style="display: flex; align-items: center; gap: 10px;">
        <label style="font-weight: 500; color: #555;">目标后缀:</label>
        <select id="targetFormat" style="padding: 8px 15px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; min-width: 120px;">
          <option value="png">.png</option>
          <option value="jpg">.jpg</option>
          <option value="jpeg">.jpeg</option>
          <option value="webp">.webp</option>
          <option value="avif">.avif</option>
          <option value="bmp">.bmp</option>
          <option value="gif">.gif</option>
        </select>
      </div>
    </div>

    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
      <button id="downloadAllRenamed" style="display: none;">下载所有重命名后的图片</button>
      <button id="resetRename" style="background: #dc3545;">重置工具</button>
    </div>
  </div>

  <!-- 图片叠加工具 -->
  <div class="tab-content" id="overlay">
    <h2>图片叠加工具</h2>
    <div class="batch-info">
      🖼️ 图片叠加：将一张图片叠加到另一张图片上，可自由调整位置和大小<br>
      🎯 拖拽定位：直接拖拽叠加图片到目标位置<br>
      📐 尺寸调整：拖拽四个角调整大小，自动保持纵横比
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
      <div>
        <h4 style="margin: 0 0 10px 0; color: #333; text-align: center;">背景图片</h4>
        <label class="drop-area" id="dropBackground" style="padding: 20px; font-size: 14px;">
          拖拽或点击上传背景图
          <input type="file" id="uploadBackground" accept="image/*">
        </label>
      </div>
      <div>
        <h4 style="margin: 0 0 10px 0; color: #333; text-align: center;">叠加图片</h4>
        <label class="drop-area" id="dropOverlay" style="padding: 20px; font-size: 14px;">
          拖拽或点击上传叠加图
          <input type="file" id="uploadOverlay" accept="image/*">
        </label>
      </div>
    </div>

    <div style="position: relative; margin: 20px 0;">
      <canvas id="overlayCanvas" style="max-width: 100%; border: 2px solid #ddd; border-radius: 8px; display: none; cursor: move;"></canvas>
      <div id="overlayPlaceholder" style="padding: 60px; text-align: center; border: 2px dashed #ccc; border-radius: 8px; color: #999; background: #fafafa;">
        请先上传背景图片和叠加图片
      </div>
    </div>

    <div class="controls" style="flex-wrap: wrap;">
      <button id="centerHorizontal" style="background: #6f42c1;" disabled>水平居中</button>
      <button id="centerVertical" style="background: #e83e8c;" disabled>垂直居中</button>
      <button id="centerBoth" style="background: #20c997;" disabled>完全居中</button>
      <button id="resetOverlay" style="background: #fd7e14;" disabled>重置位置</button>
      <button id="fitToBackground" style="background: #17a2b8;" disabled>适应背景</button>
    </div>

    <div class="controls" style="margin-top: 10px;">
      <div class="control-group">
        <label>叠加图不透明度:</label>
        <input type="range" id="overlayOpacity" min="0" max="100" value="100" style="width: 150px;" disabled>
        <span id="opacityValue" style="font-weight: 500; color: #0078d4;">100%</span>
      </div>
    </div>

    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
      <button id="downloadOverlay" disabled>下载合成后的图片</button>
      <button id="resetOverlayTool" style="background: #dc3545;">重置工具</button>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
/* ======= 标签页切换 ======= */
document.addEventListener('DOMContentLoaded', function() {
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // 移除所有活动状态
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));

      // 添加当前标签的活动状态
      tab.classList.add('active');
      const targetTab = tab.getAttribute('data-tab');
      document.getElementById(targetTab).classList.add('active');
    });
  });
});

/* ======= 裁剪工具 ======= */
let cropper, cropFileName = "cropped.png";
const imageCrop = document.getElementById('imageCrop');
const uploadCrop = document.getElementById('uploadCrop');
const downloadCrop = document.getElementById('downloadCrop');
const applyCrop = document.getElementById('applyCrop');
const preset1Btn = document.getElementById('preset1');
const preset2Btn = document.getElementById('preset2');
const savePresetBtn = document.getElementById('savePreset');
const managePresetsBtn = document.getElementById('managePresets');
const customPresetsContainer = document.getElementById('customPresets');

const posX = document.getElementById('posX');
const posY = document.getElementById('posY');
const width = document.getElementById('width');
const height = document.getElementById('height');

// 固定预设值
const CROP_PRESETS = {
  preset1: {
    x: 55,
    y: 0,
    width: 341,
    height: 65
  },
  preset2: {
    x: 65,
    y: 0,
    width: 411,
    height: 65
  }
};

// 默认使用预设1
const DEFAULT_CROP_VALUES = CROP_PRESETS.preset1;

// localStorage key
const CUSTOM_PRESETS_KEY = 'cropCustomPresets';

// 从localStorage加载自定义预设
function loadCustomPresets() {
  const saved = localStorage.getItem(CUSTOM_PRESETS_KEY);
  return saved ? JSON.parse(saved) : [];
}

// 保存自定义预设到localStorage
function saveCustomPresets(presets) {
  localStorage.setItem(CUSTOM_PRESETS_KEY, JSON.stringify(presets));
}

// 渲染自定义预设按钮
function renderCustomPresets() {
  const customPresets = loadCustomPresets();
  customPresetsContainer.innerHTML = '';

  if (customPresets.length === 0) {
    customPresetsContainer.style.display = 'none';
    return;
  }

  customPresetsContainer.style.display = 'flex';

  customPresets.forEach((preset, index) => {
    const btn = document.createElement('button');
    btn.style.cssText = 'background: #fd7e14; position: relative; padding-right: 35px;';
    btn.innerHTML = `${preset.name || '自定义' + (index + 1)} (${preset.x},${preset.y},${preset.width},${preset.height})`;

    btn.addEventListener('click', () => {
      applyPreset(preset);
    });

    customPresetsContainer.appendChild(btn);
  });
}

function handleCropFile(file){
  if (!file) return;
  cropFileName = file.name.replace(/\.[^/.]+$/, "") + ".png";
  const url = URL.createObjectURL(file);
  imageCrop.src = url;

  if (cropper) cropper.destroy();
  cropper = new Cropper(imageCrop, {
    aspectRatio: NaN,
    viewMode: 1,
    autoCropArea: 0.3,
    crop(event) {
      posX.value = Math.round(event.detail.x);
      posY.value = Math.round(event.detail.y);
      width.value = Math.round(event.detail.width);
      height.value = Math.round(event.detail.height);
    },
    ready() {
      cropper.setData(DEFAULT_CROP_VALUES);
    }
  });
}

uploadCrop.addEventListener('change', e => handleCropFile(e.target.files[0]));

// 拖拽上传
const dropCrop = document.getElementById('dropCrop');
dropCrop.addEventListener('dragover', e => { e.preventDefault(); dropCrop.classList.add('hover'); });
dropCrop.addEventListener('dragleave', e => { e.preventDefault(); dropCrop.classList.remove('hover'); });
dropCrop.addEventListener('drop', e => {
  e.preventDefault();
  dropCrop.classList.remove('hover');
  const file = e.dataTransfer.files[0];
  handleCropFile(file);
});

applyCrop.addEventListener('click', () => {
  if (!cropper) {
    alert("请先上传图片");
    return;
  }

  const x = parseInt(posX.value) || 0;
  const y = parseInt(posY.value) || 0;
  const w = parseInt(width.value) || 100;
  const h = parseInt(height.value) || 100;

  cropper.setData({ x, y, width: w, height: h });
});

downloadCrop.addEventListener('click', () => {
  if (!cropper) return alert("请先上传图片");
  const canvas = cropper.getCroppedCanvas();
  canvas.toBlob(blob => {
    const link = document.createElement('a');
    link.download = cropFileName;
    link.href = URL.createObjectURL(blob);
    link.click();
  });
});

// 应用预设值的通用函数
function applyPreset(presetValues) {
  // 更新输入框值
  posX.value = presetValues.x;
  posY.value = presetValues.y;
  width.value = presetValues.width;
  height.value = presetValues.height;

  // 如果有图片，应用裁剪
  if (cropper) {
    cropper.setData(presetValues);
  }
}

// 预设1按钮
preset1Btn.addEventListener('click', () => {
  applyPreset(CROP_PRESETS.preset1);
});

// 预设2按钮
preset2Btn.addEventListener('click', () => {
  applyPreset(CROP_PRESETS.preset2);
});

// 保存当前值为预设
savePresetBtn.addEventListener('click', () => {
  const name = prompt('请输入预设名称：', '我的预设');
  if (!name) return;

  const newPreset = {
    name: name,
    x: parseInt(posX.value) || 0,
    y: parseInt(posY.value) || 0,
    width: parseInt(width.value) || 100,
    height: parseInt(height.value) || 100
  };

  const customPresets = loadCustomPresets();
  customPresets.push(newPreset);
  saveCustomPresets(customPresets);
  renderCustomPresets();

  alert('预设已保存！');
});

// 管理预设
managePresetsBtn.addEventListener('click', () => {
  const customPresets = loadCustomPresets();

  if (customPresets.length === 0) {
    alert('暂无自定义预设');
    return;
  }

  let message = '当前自定义预设列表：\n\n';
  customPresets.forEach((preset, index) => {
    message += `${index + 1}. ${preset.name} (${preset.x},${preset.y},${preset.width},${preset.height})\n`;
  });
  message += '\n输入要删除的预设编号（多个用逗号分隔），或点击取消返回：';

  const input = prompt(message);
  if (!input) return;

  const indexesToDelete = input.split(',').map(i => parseInt(i.trim()) - 1).filter(i => i >= 0 && i < customPresets.length);

  if (indexesToDelete.length === 0) {
    alert('没有有效的编号');
    return;
  }

  // 从后往前删除，避免索引变化
  indexesToDelete.sort((a, b) => b - a).forEach(index => {
    customPresets.splice(index, 1);
  });

  saveCustomPresets(customPresets);
  renderCustomPresets();

  alert(`已删除 ${indexesToDelete.length} 个预设`);
});

// 页面加载时渲染自定义预设
renderCustomPresets();

// 重置裁剪工具
const resetCropBtn = document.getElementById('resetCrop');
resetCropBtn.addEventListener('click', () => {
  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
  imageCrop.src = '';
  uploadCrop.value = '';
  posX.value = 55;
  posY.value = 0;
  width.value = 341;
  height.value = 65;
  cropFileName = "cropped.png";
});

/* ======= 颜色替换工具 ======= */
let uploadedFiles = [];
let currentFileIndex = 0;
let processedImages = [];

const uploadReplace = document.getElementById("uploadReplace");
const fromColor = document.getElementById("fromColor");
const toColor = document.getElementById("toColor");
const toleranceInput = document.getElementById("tolerance");
const downloadReplace = document.getElementById("downloadReplace");
const downloadAllReplace = document.getElementById("downloadAllReplace");
const fromColorPreview = document.getElementById("fromColorPreview");
const toColorPreview = document.getElementById("toColorPreview");
const imageGrid = document.getElementById("imageGrid");
const gridContainer = document.getElementById("gridContainer");
const uploadCount = document.getElementById("uploadCount");

// 颜色预览更新
function updateColorPreviews() {
  try {
    fromColorPreview.style.backgroundColor = fromColor.value;
    toColorPreview.style.backgroundColor = toColor.value;
  } catch (e) {
    console.warn('颜色格式可能不正确:', e);
  }
}

fromColor.addEventListener('input', updateColorPreviews);
toColor.addEventListener('input', updateColorPreviews);

// 实时颜色替换 - 处理所有图片
function applyColorReplace() {
  if (uploadedFiles.length === 0) return;

  // 为每张图片创建处理后的canvas
  uploadedFiles.forEach((file, index) => {
    const img = new Image();
    img.onload = () => {
      // 创建临时canvas进行处理
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');

      tempCanvas.width = img.width;
      tempCanvas.height = img.height;
      tempCtx.drawImage(img, 0, 0);

      // 获取图像数据
      const imgData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
      const data = imgData.data;

      // 颜色替换处理
      const [fr, fg, fb] = hexToRgb(fromColor.value);
      const [tr, tg, tb] = hexToRgb(toColor.value);
      const tolerance = parseInt(toleranceInput.value) || 0;

      for (let i = 0; i < data.length; i += 4) {
        const dr = data[i] - fr;
        const dg = data[i+1] - fg;
        const db = data[i+2] - fb;
        const dist = Math.sqrt(dr*dr + dg*dg + db*db);

        if (dist <= tolerance) {
          data[i] = tr;
          data[i+1] = tg;
          data[i+2] = tb;
        }
      }

      // 应用处理后的图像数据
      tempCtx.putImageData(imgData, 0, 0);

      // 保存处理后的图片数据
      processedImages[index] = tempCanvas.toDataURL("image/png");

      // 更新网格中对应图片的显示
      updateGridImage(index, processedImages[index]);
    };

    img.onerror = () => {
      console.error('图片加载失败:', file.name);
    };

    const url = URL.createObjectURL(file);
    img.src = url;
  });
}

// 更新网格中指定图片的显示
function updateGridImage(index, processedImageData) {
  const gridItems = gridContainer.children;
  if (gridItems[index]) {
    const img = gridItems[index].querySelector('img');
    if (img && processedImageData) {
      img.src = processedImageData;
    }
  }
}

// 防抖函数
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// 创建防抖的颜色替换函数
const debouncedApplyColorReplace = debounce(applyColorReplace, 100);

// 监听颜色和容差变化，实时应用替换
fromColor.addEventListener('input', debouncedApplyColorReplace);
toColor.addEventListener('input', debouncedApplyColorReplace);
toleranceInput.addEventListener('input', debouncedApplyColorReplace);

function handleReplaceFiles(files) {
  console.log('上传文件数量:', files.length);

  if (!files || files.length === 0) {
    console.log('没有文件上传');
    return;
  }

  // 验证文件类型
  const validFiles = Array.from(files).filter(file => {
    const isValid = file.type.startsWith('image/');
    if (!isValid) {
      console.warn('无效文件类型:', file.name, file.type);
    }
    return isValid;
  });

  if (validFiles.length === 0) {
    alert('请上传有效的图片文件');
    return;
  }

  uploadedFiles = validFiles;
  processedImages = new Array(validFiles.length);
  currentFileIndex = 0;

  console.log('有效文件数量:', uploadedFiles.length);

  // 显示图片网格
  imageGrid.style.display = 'block';
  updateImageGrid();

  if (validFiles.length > 1) {
    downloadAllReplace.style.display = 'inline-block';
  } else {
    downloadAllReplace.style.display = 'none';
  }

  applyColorReplace();
}

function updateImageGrid() {
  // 更新上传总数
  uploadCount.textContent = `已上传 ${uploadedFiles.length} 张`;

  gridContainer.innerHTML = '';

  uploadedFiles.forEach((file, index) => {
    const gridItem = document.createElement('div');
    gridItem.style.cssText = `
      position: relative;
      border: 2px solid ${index === currentFileIndex ? '#0078d4' : '#dee2e6'};
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8f9fa;
    `;

    const img = document.createElement('img');
    img.style.cssText = `
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    `;

    const fileName = document.createElement('div');
    fileName.style.cssText = `
      padding: 8px;
      font-size: 12px;
      color: #666;
      text-align: center;
      background: rgba(255,255,255,0.9);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    `;
    fileName.textContent = file.name;

    const statusIndicator = document.createElement('div');
    statusIndicator.style.cssText = `
      position: absolute;
      top: 5px;
      right: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: ${processedImages[index] ? '#28a745' : '#ffc107'};
      border: 2px solid #fff;
    `;

    gridItem.appendChild(img);
    gridItem.appendChild(fileName);
    gridItem.appendChild(statusIndicator);

    // 加载图片 - 如果已处理则显示处理后的图片，否则显示原图
    if (processedImages[index]) {
      img.src = processedImages[index];
    } else {
      const url = URL.createObjectURL(file);
      img.src = url;
    }

    // 点击切换当前选中图片
    gridItem.addEventListener('click', () => {
      currentFileIndex = index;
      updateImageGrid();
    });

    // 悬停效果
    gridItem.addEventListener('mouseenter', () => {
      if (index !== currentFileIndex) {
        gridItem.style.borderColor = '#0078d4';
        gridItem.style.transform = 'scale(1.02)';
      }
    });

    gridItem.addEventListener('mouseleave', () => {
      if (index !== currentFileIndex) {
        gridItem.style.borderColor = '#dee2e6';
        gridItem.style.transform = 'scale(1)';
      }
    });

    gridContainer.appendChild(gridItem);
  });
}

uploadReplace.addEventListener("change", e => handleReplaceFiles(e.target.files));

const dropReplace = document.getElementById('dropReplace');
dropReplace.addEventListener('dragover', e => { e.preventDefault(); dropReplace.classList.add('hover'); });
dropReplace.addEventListener('dragleave', e => { e.preventDefault(); dropReplace.classList.remove('hover'); });
dropReplace.addEventListener('drop', e => {
  e.preventDefault();
  dropReplace.classList.remove('hover');
  handleReplaceFiles(e.dataTransfer.files);
});

// 将颜色值转换为RGB数组，支持十六进制（#ff0000）和命名颜色（red）
function colorToRgb(color) {
  // 去除空格
  color = color.trim();

  // 如果是十六进制颜色
  if (color.startsWith('#')) {
    const hex = color.replace("#", "");
    const bigint = parseInt(hex, 16);
    return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
  }

  // 如果是rgb/rgba格式
  if (color.startsWith('rgb')) {
    const match = color.match(/\d+/g);
    if (match && match.length >= 3) {
      return [parseInt(match[0]), parseInt(match[1]), parseInt(match[2])];
    }
  }

  // 对于命名颜色，使用canvas来转换
  const canvas = document.createElement('canvas');
  canvas.width = canvas.height = 1;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = color;
  ctx.fillRect(0, 0, 1, 1);
  const imageData = ctx.getImageData(0, 0, 1, 1).data;
  return [imageData[0], imageData[1], imageData[2]];
}

// 保留旧函数名以兼容
function hexToRgb(hex) {
  return colorToRgb(hex);
}

downloadReplace.addEventListener("click", () => {
  if (uploadedFiles.length === 0) return;
  if (!processedImages[currentFileIndex]) return;

  const link = document.createElement("a");
  const fileName = uploadedFiles[currentFileIndex].name.replace(/\.[^/.]+$/, "") + "_replaced.png";
  link.download = fileName;
  link.href = processedImages[currentFileIndex];
  link.click();
});

downloadAllReplace.addEventListener("click", () => {
  if (uploadedFiles.length === 0) return;

  // 检查是否所有图片都已处理
  const allProcessed = processedImages.every(img => img !== undefined);
  if (!allProcessed) return;

  // 批量下载所有图片
  uploadedFiles.forEach((file, index) => {
    setTimeout(() => {
      const link = document.createElement("a");
      const fileName = file.name.replace(/\.[^/.]+$/, "") + "_replaced.png";
      link.download = fileName;
      link.href = processedImages[index];
      link.click();
    }, index * 200);
  });
});

// 重置颜色替换工具
const resetReplaceBtn = document.getElementById('resetReplace');
resetReplaceBtn.addEventListener('click', () => {
  uploadedFiles = [];
  processedImages = [];
  currentFileIndex = 0;
  uploadReplace.value = '';
  imageGrid.style.display = 'none';
  gridContainer.innerHTML = '';
  downloadAllReplace.style.display = 'none';
  fromColor.value = '#000000';
  toColor.value = '#ff0000';
  toleranceInput.value = 999;
  updateColorPreviews();
});

/* ======= 批量重命名工具 ======= */
let renameFiles = [];

const uploadRename = document.getElementById("uploadRename");
const dropRename = document.getElementById("dropRename");
const renameImageGrid = document.getElementById("renameImageGrid");
const renameGridContainer = document.getElementById("renameGridContainer");
const renameUploadCount = document.getElementById("renameUploadCount");
const targetFormat = document.getElementById("targetFormat");
const downloadAllRenamed = document.getElementById("downloadAllRenamed");
const formatBtns = document.querySelectorAll(".format-btn");

// 格式按钮点击
formatBtns.forEach(btn => {
  btn.addEventListener("click", () => {
    const format = btn.getAttribute("data-format");
    targetFormat.value = format;
    if (renameFiles.length > 0) {
      updateRenameGrid();
    }
  });
});

// 目标格式改变
targetFormat.addEventListener("change", () => {
  if (renameFiles.length > 0) {
    updateRenameGrid();
  }
});

// 处理上传的文件
function handleRenameFiles(files) {
  if (!files || files.length === 0) return;

  const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

  if (validFiles.length === 0) {
    alert('请上传有效的图片文件');
    return;
  }

  renameFiles = validFiles;

  renameImageGrid.style.display = 'block';
  downloadAllRenamed.style.display = 'inline-block';

  updateRenameGrid();
}

// 更新图片列表显示
function updateRenameGrid() {
  renameUploadCount.textContent = `已上传 ${renameFiles.length} 张`;
  renameGridContainer.innerHTML = '';

  renameFiles.forEach((file, index) => {
    const itemDiv = document.createElement('div');
    itemDiv.style.cssText = `
      display: flex;
      align-items: center;
      background: #fff;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    `;

    const img = document.createElement('img');
    img.style.cssText = `
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 15px;
      border: 2px solid #dee2e6;
    `;
    img.src = URL.createObjectURL(file);

    const infoDiv = document.createElement('div');
    infoDiv.style.cssText = `
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
    `;

    const originalName = document.createElement('div');
    originalName.style.cssText = `
      font-size: 14px;
      color: #666;
      font-weight: 400;
    `;
    originalName.textContent = `原文件: ${file.name}`;

    const arrow = document.createElement('div');
    arrow.style.cssText = `
      font-size: 16px;
      color: #0078d4;
      font-weight: bold;
    `;
    arrow.textContent = '↓';

    const newName = document.createElement('div');
    newName.style.cssText = `
      font-size: 14px;
      color: #0078d4;
      font-weight: 500;
    `;
    newName.id = `newName-${index}`;
    const newFileName = getNewFileName(file.name, targetFormat.value);
    newName.textContent = `新文件: ${newFileName}`;

    infoDiv.appendChild(originalName);
    infoDiv.appendChild(arrow);
    infoDiv.appendChild(newName);

    itemDiv.appendChild(img);
    itemDiv.appendChild(infoDiv);

    // 悬停效果
    itemDiv.addEventListener('mouseenter', () => {
      itemDiv.style.transform = 'translateX(5px)';
      itemDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
    });

    itemDiv.addEventListener('mouseleave', () => {
      itemDiv.style.transform = 'translateX(0)';
      itemDiv.style.boxShadow = '0 2px 6px rgba(0,0,0,0.08)';
    });

    renameGridContainer.appendChild(itemDiv);
  });
}

// 获取新文件名
function getNewFileName(originalName, format) {
  const nameWithoutExt = originalName.replace(/\.[^/.]+$/, "");
  return `${nameWithoutExt}.${format}`;
}

// 文件上传事件
uploadRename.addEventListener("change", e => handleRenameFiles(e.target.files));

// 拖拽上传
dropRename.addEventListener('dragover', e => {
  e.preventDefault();
  dropRename.classList.add('hover');
});

dropRename.addEventListener('dragleave', e => {
  e.preventDefault();
  dropRename.classList.remove('hover');
});

dropRename.addEventListener('drop', e => {
  e.preventDefault();
  dropRename.classList.remove('hover');
  handleRenameFiles(e.dataTransfer.files);
});

// 下载所有重命名后的图片
downloadAllRenamed.addEventListener("click", () => {
  if (renameFiles.length === 0) return;

  const format = targetFormat.value;

  renameFiles.forEach((file, index) => {
    setTimeout(() => {
      const link = document.createElement("a");
      const newFileName = getNewFileName(file.name, format);
      link.download = newFileName;
      link.href = URL.createObjectURL(file);
      link.click();
    }, index * 200);
  });
});

// 重置批量重命名工具
const resetRenameBtn = document.getElementById('resetRename');
resetRenameBtn.addEventListener('click', () => {
  renameFiles = [];
  uploadRename.value = '';
  renameImageGrid.style.display = 'none';
  renameGridContainer.innerHTML = '';
  downloadAllRenamed.style.display = 'none';
  targetFormat.value = 'png';
});

/* ======= 图片叠加工具 ======= */
let backgroundImg = null;
let overlayImg = null;
let overlayX = 0;
let overlayY = 0;
let overlayWidth = 0;
let overlayHeight = 0;
let overlayOpacityValue = 1;
let isDragging = false;
let isResizing = false;
let dragStartX = 0;
let dragStartY = 0;
let resizeCorner = null;
let overlayAspectRatio = 1;

const uploadBackground = document.getElementById("uploadBackground");
const uploadOverlayImg = document.getElementById("uploadOverlay");
const dropBackground = document.getElementById("dropBackground");
const dropOverlayArea = document.getElementById("dropOverlay");
const overlayCanvas = document.getElementById("overlayCanvas");
const overlayPlaceholder = document.getElementById("overlayPlaceholder");
const ctx = overlayCanvas.getContext("2d");

const centerHorizontalBtn = document.getElementById("centerHorizontal");
const centerVerticalBtn = document.getElementById("centerVertical");
const centerBothBtn = document.getElementById("centerBoth");
const resetOverlayBtn = document.getElementById("resetOverlay");
const fitToBackgroundBtn = document.getElementById("fitToBackground");
const overlayOpacitySlider = document.getElementById("overlayOpacity");
const opacityValueSpan = document.getElementById("opacityValue");
const downloadOverlayBtn = document.getElementById("downloadOverlay");

// 上传背景图片
function handleBackgroundUpload(file) {
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      backgroundImg = img;
      initializeCanvas();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// 上传叠加图片
function handleOverlayUpload(file) {
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      overlayImg = img;
      overlayAspectRatio = img.width / img.height;
      initializeCanvas();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// 初始化画布
function initializeCanvas() {
  if (!backgroundImg) return;

  // 设置画布大小为背景图片大小
  overlayCanvas.width = backgroundImg.width;
  overlayCanvas.height = backgroundImg.height;

  overlayCanvas.style.display = 'block';
  overlayPlaceholder.style.display = 'none';

  // 如果有叠加图片，初始化其位置和大小
  if (overlayImg) {
    const scale = Math.min(
      (backgroundImg.width * 0.5) / overlayImg.width,
      (backgroundImg.height * 0.5) / overlayImg.height
    );
    overlayWidth = overlayImg.width * scale;
    overlayHeight = overlayImg.height * scale;
    overlayX = (backgroundImg.width - overlayWidth) / 2;
    overlayY = (backgroundImg.height - overlayHeight) / 2;

    // 启用所有控制按钮
    centerHorizontalBtn.disabled = false;
    centerVerticalBtn.disabled = false;
    centerBothBtn.disabled = false;
    resetOverlayBtn.disabled = false;
    fitToBackgroundBtn.disabled = false;
    overlayOpacitySlider.disabled = false;
    downloadOverlayBtn.disabled = false;
  }

  drawCanvas();
}

// 绘制画布
function drawCanvas() {
  if (!backgroundImg) return;

  ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

  // 绘制背景图片
  ctx.drawImage(backgroundImg, 0, 0);

  // 如果有叠加图片，绘制叠加图片及控制元素
  if (overlayImg) {
    // 绘制叠加图片
    ctx.globalAlpha = overlayOpacityValue;
    ctx.drawImage(overlayImg, overlayX, overlayY, overlayWidth, overlayHeight);
    ctx.globalAlpha = 1;

    // 绘制叠加图片的边框和控制点
    ctx.strokeStyle = '#0078d4';
    ctx.lineWidth = 2;
    ctx.strokeRect(overlayX, overlayY, overlayWidth, overlayHeight);

    // 绘制四个角的控制点
    const corners = [
      { x: overlayX, y: overlayY, cursor: 'nw-resize' },
      { x: overlayX + overlayWidth, y: overlayY, cursor: 'ne-resize' },
      { x: overlayX, y: overlayY + overlayHeight, cursor: 'sw-resize' },
      { x: overlayX + overlayWidth, y: overlayY + overlayHeight, cursor: 'se-resize' }
    ];

    ctx.fillStyle = '#0078d4';
    corners.forEach(corner => {
      ctx.fillRect(corner.x - 5, corner.y - 5, 10, 10);
    });
  }
}

// 获取鼠标在画布上的位置
function getMousePos(e) {
  const rect = overlayCanvas.getBoundingClientRect();
  const scaleX = overlayCanvas.width / rect.width;
  const scaleY = overlayCanvas.height / rect.height;

  return {
    x: (e.clientX - rect.left) * scaleX,
    y: (e.clientY - rect.top) * scaleY
  };
}

// 检查是否在控制点上
function getResizeCorner(x, y) {
  const corners = [
    { x: overlayX, y: overlayY, name: 'nw' },
    { x: overlayX + overlayWidth, y: overlayY, name: 'ne' },
    { x: overlayX, y: overlayY + overlayHeight, name: 'sw' },
    { x: overlayX + overlayWidth, y: overlayY + overlayHeight, name: 'se' }
  ];

  for (let corner of corners) {
    const distance = Math.sqrt((x - corner.x) ** 2 + (y - corner.y) ** 2);
    if (distance < 10) {
      return corner.name;
    }
  }
  return null;
}

// 鼠标按下事件
overlayCanvas.addEventListener('mousedown', (e) => {
  if (!backgroundImg || !overlayImg) return;

  const pos = getMousePos(e);
  resizeCorner = getResizeCorner(pos.x, pos.y);

  if (resizeCorner) {
    isResizing = true;
    dragStartX = pos.x;
    dragStartY = pos.y;
  } else if (pos.x >= overlayX && pos.x <= overlayX + overlayWidth &&
             pos.y >= overlayY && pos.y <= overlayY + overlayHeight) {
    isDragging = true;
    dragStartX = pos.x - overlayX;
    dragStartY = pos.y - overlayY;
  }
});

// 鼠标移动事件
overlayCanvas.addEventListener('mousemove', (e) => {
  if (!backgroundImg || !overlayImg) return;

  const pos = getMousePos(e);

  if (isDragging) {
    overlayX = pos.x - dragStartX;
    overlayY = pos.y - dragStartY;

    // 限制在画布范围内
    overlayX = Math.max(0, Math.min(overlayX, overlayCanvas.width - overlayWidth));
    overlayY = Math.max(0, Math.min(overlayY, overlayCanvas.height - overlayHeight));

    drawCanvas();
  } else if (isResizing) {
    const deltaX = pos.x - dragStartX;
    const deltaY = pos.y - dragStartY;

    let newWidth = overlayWidth;
    let newHeight = overlayHeight;
    let newX = overlayX;
    let newY = overlayY;

    // 根据拖拽的角计算新的尺寸，保持纵横比
    if (resizeCorner === 'se') {
      newWidth = overlayWidth + deltaX;
      newHeight = newWidth / overlayAspectRatio;
    } else if (resizeCorner === 'sw') {
      newWidth = overlayWidth - deltaX;
      newHeight = newWidth / overlayAspectRatio;
      newX = overlayX + deltaX;
    } else if (resizeCorner === 'ne') {
      newWidth = overlayWidth + deltaX;
      newHeight = newWidth / overlayAspectRatio;
      newY = overlayY - (newHeight - overlayHeight);
    } else if (resizeCorner === 'nw') {
      newWidth = overlayWidth - deltaX;
      newHeight = newWidth / overlayAspectRatio;
      newX = overlayX + deltaX;
      newY = overlayY - (newHeight - overlayHeight);
    }

    // 确保尺寸不小于10px
    if (newWidth > 10 && newHeight > 10) {
      overlayWidth = newWidth;
      overlayHeight = newHeight;
      overlayX = newX;
      overlayY = newY;
      dragStartX = pos.x;
      dragStartY = pos.y;
      drawCanvas();
    }
  } else {
    // 更新鼠标样式
    const corner = getResizeCorner(pos.x, pos.y);
    if (corner) {
      overlayCanvas.style.cursor = corner + '-resize';
    } else if (pos.x >= overlayX && pos.x <= overlayX + overlayWidth &&
               pos.y >= overlayY && pos.y <= overlayY + overlayHeight) {
      overlayCanvas.style.cursor = 'move';
    } else {
      overlayCanvas.style.cursor = 'default';
    }
  }
});

// 鼠标释放事件
overlayCanvas.addEventListener('mouseup', () => {
  isDragging = false;
  isResizing = false;
  resizeCorner = null;
});

overlayCanvas.addEventListener('mouseleave', () => {
  isDragging = false;
  isResizing = false;
  resizeCorner = null;
});

// 水平居中
centerHorizontalBtn.addEventListener('click', () => {
  overlayX = (overlayCanvas.width - overlayWidth) / 2;
  drawCanvas();
});

// 垂直居中
centerVerticalBtn.addEventListener('click', () => {
  overlayY = (overlayCanvas.height - overlayHeight) / 2;
  drawCanvas();
});

// 完全居中
centerBothBtn.addEventListener('click', () => {
  overlayX = (overlayCanvas.width - overlayWidth) / 2;
  overlayY = (overlayCanvas.height - overlayHeight) / 2;
  drawCanvas();
});

// 重置位置
resetOverlayBtn.addEventListener('click', () => {
  if (!backgroundImg || !overlayImg) return;

  const scale = Math.min(
    (backgroundImg.width * 0.5) / overlayImg.width,
    (backgroundImg.height * 0.5) / overlayImg.height
  );
  overlayWidth = overlayImg.width * scale;
  overlayHeight = overlayImg.height * scale;
  overlayX = (backgroundImg.width - overlayWidth) / 2;
  overlayY = (backgroundImg.height - overlayHeight) / 2;

  drawCanvas();
});

// 适应背景
fitToBackgroundBtn.addEventListener('click', () => {
  if (!backgroundImg || !overlayImg) return;

  const scale = Math.min(
    backgroundImg.width / overlayImg.width,
    backgroundImg.height / overlayImg.height
  );
  overlayWidth = overlayImg.width * scale;
  overlayHeight = overlayImg.height * scale;
  overlayX = (backgroundImg.width - overlayWidth) / 2;
  overlayY = (backgroundImg.height - overlayHeight) / 2;

  drawCanvas();
});

// 不透明度调整
overlayOpacitySlider.addEventListener('input', () => {
  overlayOpacityValue = overlayOpacitySlider.value / 100;
  opacityValueSpan.textContent = overlayOpacitySlider.value + '%';
  drawCanvas();
});

// 下载合成图片
downloadOverlayBtn.addEventListener('click', () => {
  if (!backgroundImg || !overlayImg) return;

  // 创建最终合成的canvas
  const finalCanvas = document.createElement('canvas');
  finalCanvas.width = overlayCanvas.width;
  finalCanvas.height = overlayCanvas.height;
  const finalCtx = finalCanvas.getContext('2d');

  // 绘制背景
  finalCtx.drawImage(backgroundImg, 0, 0);

  // 绘制叠加图片
  finalCtx.globalAlpha = overlayOpacityValue;
  finalCtx.drawImage(overlayImg, overlayX, overlayY, overlayWidth, overlayHeight);
  finalCtx.globalAlpha = 1;

  // 下载
  finalCanvas.toBlob(blob => {
    const link = document.createElement('a');
    link.download = 'overlay_result.png';
    link.href = URL.createObjectURL(blob);
    link.click();
  });
});

// 文件上传事件
uploadBackground.addEventListener('change', e => handleBackgroundUpload(e.target.files[0]));
uploadOverlayImg.addEventListener('change', e => handleOverlayUpload(e.target.files[0]));

// 拖拽上传 - 背景图片
dropBackground.addEventListener('dragover', e => {
  e.preventDefault();
  dropBackground.classList.add('hover');
});

dropBackground.addEventListener('dragleave', e => {
  e.preventDefault();
  dropBackground.classList.remove('hover');
});

dropBackground.addEventListener('drop', e => {
  e.preventDefault();
  dropBackground.classList.remove('hover');
  handleBackgroundUpload(e.dataTransfer.files[0]);
});

// 拖拽上传 - 叠加图片
dropOverlayArea.addEventListener('dragover', e => {
  e.preventDefault();
  dropOverlayArea.classList.add('hover');
});

dropOverlayArea.addEventListener('dragleave', e => {
  e.preventDefault();
  dropOverlayArea.classList.remove('hover');
});

dropOverlayArea.addEventListener('drop', e => {
  e.preventDefault();
  dropOverlayArea.classList.remove('hover');
  handleOverlayUpload(e.dataTransfer.files[0]);
});

// 重置图片叠加工具
const resetOverlayToolBtn = document.getElementById('resetOverlayTool');
resetOverlayToolBtn.addEventListener('click', () => {
  // 清空图片
  backgroundImg = null;
  overlayImg = null;
  overlayX = 0;
  overlayY = 0;
  overlayWidth = 0;
  overlayHeight = 0;
  overlayOpacityValue = 1;
  isDragging = false;
  isResizing = false;
  resizeCorner = null;
  overlayAspectRatio = 1;

  // 清空输入
  uploadBackground.value = '';
  uploadOverlayImg.value = '';

  // 清空画布
  ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
  overlayCanvas.style.display = 'none';
  overlayPlaceholder.style.display = 'block';

  // 禁用按钮
  centerHorizontalBtn.disabled = true;
  centerVerticalBtn.disabled = true;
  centerBothBtn.disabled = true;
  resetOverlayBtn.disabled = true;
  fitToBackgroundBtn.disabled = true;
  overlayOpacitySlider.disabled = true;
  downloadOverlayBtn.disabled = true;

  // 重置不透明度
  overlayOpacitySlider.value = 100;
  opacityValueSpan.textContent = '100%';
});
</script>
</body>
</html>
