<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>图片处理工具</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #333;
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .header p {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .tab {
            padding: 15px 30px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: #fff;
            color: #0078d4;
            border-bottom-color: #0078d4;
        }

        .tab:hover {
            background: #e9ecef;
            color: #0078d4;
        }

        .tab-content {
            display: none;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: 400;
        }

        .drop-area {
            display: flex;
            padding: 30px;
            border: 2px dashed #bbb;
            border-radius: 12px;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            color: #666;
        }

        .drop-area.hover {
            border-color: #0078d4;
            background: #f0f8ff;
            color: #0078d4;
        }

        .img-container {
            width: 100%;
            max-height: 400px;
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #fafafa;
        }

        .img-container img,
        .img-container canvas {
            max-width: 100%;
            max-height: 100%;
            display: block;
            margin: auto;
        }

        input[type="number"],
        input[type="text"] {
            width: 100px;
            padding: 8px;
            margin: 0 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            text-align: center;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #0078d4;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .control-group label {
            font-weight: 500;
            color: #555;
        }

        button {
            padding: 10px 20px;
            margin: 8px;
            border: none;
            border-radius: 8px;
            background-color: #0078d4;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: #005a9e;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        input[type="file"] {
            display: none;
        }

        .batch-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #1976d2;
            font-size: 14px;
        }

        .color-preview {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin: 0 5px;
            border: 2px solid #ddd;
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>图片处理工具</h1>
        <p>专业的在线图片编辑工具，支持裁剪、颜色替换、批量重命名、图片叠加、图片拼接、GIF制作等6大功能</p>
    </div>

    <div class="tabs">
        <button class="tab active" data-tab="crop">图片裁剪</button>
        <button class="tab" data-tab="replace">颜色替换</button>
        <button class="tab" data-tab="rename">批量重命名</button>
        <button class="tab" data-tab="overlay">图片叠加</button>
        <button class="tab" data-tab="stitch">图片拼接</button>
        <button class="tab" data-tab="gif">GIF制作</button>
    </div>

    <!-- 裁剪工具 -->
    <div class="tab-content active" id="crop">
        <h2>图片裁剪工具</h2>
        <label class="drop-area" id="dropCrop">拖拽或点击上传图片
            <input type="file" id="uploadCrop" accept="image/*">
        </label>

        <div class="img-container">
            <img id="imageCrop" alt="请上传图片">
        </div>

        <div class="controls">
            <div class="control-group">
                <label>X:</label>
                <input type="number" id="posX" value="55">
            </div>
            <div class="control-group">
                <label>Y:</label>
                <input type="number" id="posY" value="0">
            </div>
            <div class="control-group">
                <label>W:</label>
                <input type="number" id="width" value="341">
            </div>
            <div class="control-group">
                <label>H:</label>
                <input type="number" id="height" value="65">
            </div>
            <button id="applyCrop">应用裁剪</button>
        </div>

        <div style="margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
            <button id="preset1" style="background: #6c757d;">预设1 (55,0,341,65)</button>
            <button id="preset2" style="background: #6c757d;">预设2 (65,0,411,65)</button>
        </div>

        <div id="customPresets"
            style="margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
            <!-- 自定义预设按钮将动态插入到这里 -->
        </div>

        <div style="margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
            <button id="savePreset" style="background: #28a745;">保存当前值为预设</button>
            <button id="managePresets" style="background: #17a2b8;">管理预设</button>
        </div>

        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
            <button id="downloadCrop">下载裁剪后的图片</button>
            <button id="resetCrop" style="background: #dc3545;">重置工具</button>
        </div>
    </div>

    <!-- 颜色替换工具 -->
    <div class="tab-content" id="replace">
        <h2>图片颜色替换工具</h2>
        <div class="batch-info">
            💡 支持批量处理：上传多张图片，系统会自动为每张图片应用相同的颜色替换设置<br>
            🎨 支持多种颜色格式：十六进制（#ff0000）、命名颜色（red、blue）、RGB（rgb(255,0,0)）
        </div>

        <label class="drop-area" id="dropReplace">拖拽或点击上传图片（支持多选）
            <input type="file" id="uploadReplace" accept="image/*" multiple>
        </label>

        <div id="imageGrid" style="display: none; margin: 15px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0; color: #333;">图片预览</h4>
                <span id="uploadCount"
                    style="background: #0078d4; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 500;"></span>
            </div>
            <div id="gridContainer"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; max-height: 500px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px;">
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>原颜色:</label>
                <span class="color-preview" id="fromColorPreview" style="background-color: #000000;"></span>
                <input type="text" id="fromColor" value="#000000" placeholder="如: #000000 或 black">
            </div>
            <div class="control-group">
                <label>目标颜色:</label>
                <span class="color-preview" id="toColorPreview" style="background-color: #ff0000;"></span>
                <input type="text" id="toColor" value="#ff0000" placeholder="如: #ff0000 或 red">
            </div>
            <div class="control-group">
                <label>容差:</label>
                <input type="number" id="tolerance" value="999" min="0" max="441">
            </div>
            <button id="applyReplace" style="background: #0078d4;">应用替换</button>
        </div>

        <!-- 替换历史记录 -->
        <div id="replaceHistory"
            style="display: none; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="margin: 0 0 15px 0; color: #333;">替换历史</h4>
            <div id="historyList" style="display: flex; flex-direction: column; gap: 8px;"></div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button id="undoReplace" style="background: #6c757d; font-size: 14px;" disabled>撤销上一步</button>
                <button id="clearHistory" style="background: #dc3545; font-size: 14px;">清空历史</button>
            </div>
        </div>

        <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
            <button id="downloadReplace">下载当前图片</button>
            <button id="downloadAllReplace" style="display: none;">下载所有图片</button>
            <button id="downloadZipReplace" style="display: none; background: #28a745;">下载压缩包</button>
            <button id="resetReplace" style="background: #dc3545;">重置工具</button>
        </div>
    </div>

    <!-- 批量重命名工具 -->
    <div class="tab-content" id="rename">
        <h2>批量重命名图片后缀</h2>
        <div class="batch-info">
            ✏️ 批量重命名：上传多张图片，一键修改所有图片的文件后缀名<br>
            📦 预设后缀：.png、.jpg、.webp、.avif、.bmp、.gif 等常用格式<br>
            ⚡ 注意：仅修改文件名后缀，不进行实际格式转换
        </div>

        <label class="drop-area" id="dropRename">拖拽或点击上传图片（支持多选）
            <input type="file" id="uploadRename" accept="image/*" multiple>
        </label>

        <div id="renameImageGrid" style="display: none; margin: 15px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0; color: #333;">图片列表</h4>
                <span id="renameUploadCount"
                    style="background: #0078d4; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 500;"></span>
            </div>
            <div id="renameGridContainer"
                style="max-height: 400px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px;">
            </div>
        </div>

        <div class="controls" style="flex-direction: column; gap: 20px; margin-top: 20px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button class="format-btn" data-format="png" style="background: #6f42c1;">.png</button>
                <button class="format-btn" data-format="jpg" style="background: #e83e8c;">.jpg</button>
                <button class="format-btn" data-format="jpeg" style="background: #d63384;">.jpeg</button>
                <button class="format-btn" data-format="webp" style="background: #20c997;">.webp</button>
                <button class="format-btn" data-format="avif" style="background: #fd7e14;">.avif</button>
                <button class="format-btn" data-format="bmp" style="background: #6c757d;">.bmp</button>
                <button class="format-btn" data-format="gif" style="background: #17a2b8;">.gif</button>
            </div>

            <div style="display: flex; align-items: center; gap: 10px;">
                <label style="font-weight: 500; color: #555;">目标后缀:</label>
                <select id="targetFormat"
                    style="padding: 8px 15px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; min-width: 120px;">
                    <option value="png">.png</option>
                    <option value="jpg">.jpg</option>
                    <option value="jpeg">.jpeg</option>
                    <option value="webp">.webp</option>
                    <option value="avif">.avif</option>
                    <option value="bmp">.bmp</option>
                    <option value="gif">.gif</option>
                </select>
            </div>
        </div>

        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
            <button id="downloadAllRenamed" style="display: none;">下载所有重命名后的图片</button>
            <button id="resetRename" style="background: #dc3545;">重置工具</button>
        </div>
    </div>

    <!-- 图片叠加工具 -->
    <div class="tab-content" id="overlay">
        <h2>图片叠加工具</h2>
        <div class="batch-info">
            🖼️ 图片叠加：将一张图片叠加到另一张图片上，可自由调整位置和大小<br>
            🎯 拖拽定位：直接拖拽叠加图片到目标位置<br>
            📐 尺寸调整：拖拽四个角调整大小，自动保持纵横比
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
            <div>
                <h4 style="margin: 0 0 10px 0; color: #333; text-align: center;">背景图片</h4>
                <label class="drop-area" id="dropBackground" style="padding: 20px; font-size: 14px;">
                    拖拽或点击上传背景图
                    <input type="file" id="uploadBackground" accept="image/*">
                </label>
            </div>
            <div>
                <h4 style="margin: 0 0 10px 0; color: #333; text-align: center;">叠加图片</h4>
                <label class="drop-area" id="dropOverlay" style="padding: 20px; font-size: 14px;">
                    拖拽或点击上传叠加图
                    <input type="file" id="uploadOverlay" accept="image/*">
                </label>
            </div>
        </div>

        <div style="position: relative; margin: 20px 0;">
            <canvas id="overlayCanvas"
                style="max-width: 100%; border: 2px solid #ddd; border-radius: 8px; display: none; cursor: move;"></canvas>
            <div id="overlayPlaceholder"
                style="padding: 60px; text-align: center; border: 2px dashed #ccc; border-radius: 8px; color: #999; background: #fafafa;">
                请先上传背景图片和叠加图片
            </div>
        </div>

        <div class="controls" style="flex-wrap: wrap;">
            <button id="centerHorizontal" style="background: #6f42c1;" disabled>水平居中</button>
            <button id="centerVertical" style="background: #e83e8c;" disabled>垂直居中</button>
            <button id="centerBoth" style="background: #20c997;" disabled>完全居中</button>
            <button id="resetOverlay" style="background: #fd7e14;" disabled>重置位置</button>
            <button id="fitToBackground" style="background: #17a2b8;" disabled>适应背景</button>
        </div>

        <div class="controls" style="margin-top: 10px;">
            <div class="control-group">
                <label>叠加图不透明度:</label>
                <input type="range" id="overlayOpacity" min="0" max="100" value="100" style="width: 150px;" disabled>
                <span id="opacityValue" style="font-weight: 500; color: #0078d4;">100%</span>
            </div>
        </div>

        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
            <button id="downloadOverlay" disabled>下载合成后的图片</button>
            <button id="resetOverlayTool" style="background: #dc3545;">重置工具</button>
        </div>
    </div>

    <!-- 图片拼接工具 -->
    <div class="tab-content" id="stitch">
        <h2>图片拼接工具</h2>
        <div class="batch-info">
            🖼️ 图片拼接：将多张图片拼接成一张图片<br>
            📐 多种模式：支持水平、垂直、网格拼接<br>
            ✨ 拖拽排序：拖拽调整图片顺序
        </div>

        <label class="drop-area" id="dropStitch">拖拽或点击上传图片（支持多选）
            <input type="file" id="uploadStitch" accept="image/*" multiple>
        </label>

        <div id="stitchImageList" style="display: none; margin: 20px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0; color: #333;">图片列表（拖拽调整顺序）</h4>
                <span id="stitchUploadCount"
                    style="background: #0078d4; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 500;"></span>
            </div>
            <div id="stitchListContainer"
                style="display: flex; gap: 10px; flex-wrap: wrap; padding: 15px; background: #f8f9fa; border-radius: 8px; min-height: 100px;">
            </div>
        </div>

        <div class="controls" style="flex-direction: column; gap: 20px; margin-top: 20px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button class="stitch-mode-btn" data-mode="horizontal" style="background: #6f42c1;">水平拼接</button>
                <button class="stitch-mode-btn" data-mode="vertical" style="background: #e83e8c;">垂直拼接</button>
                <button class="stitch-mode-btn" data-mode="row2" style="background: #20c997;">一行2个</button>
                <button class="stitch-mode-btn" data-mode="row3" style="background: #fd7e14;">一行3个</button>
                <button class="stitch-mode-btn" data-mode="row4" style="background: #17a2b8;">一行4个</button>
                <button class="stitch-mode-btn" data-mode="row5" style="background: #6c757d;">一行5个</button>
            </div>

            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: center;">
                <div class="control-group">
                    <label>拼接模式:</label>
                    <select id="stitchMode"
                        style="padding: 8px 15px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; min-width: 120px;">
                        <option value="horizontal">水平拼接</option>
                        <option value="vertical">垂直拼接</option>
                        <option value="row2">一行2个</option>
                        <option value="row3" selected>一行3个</option>
                        <option value="row4">一行4个</option>
                        <option value="row5">一行5个</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>图片间距:</label>
                    <input type="number" id="stitchGap" value="0" min="0" max="100" style="width: 80px;">
                    <span>px</span>
                </div>

                <div class="control-group">
                    <label>背景颜色:</label>
                    <input type="color" id="stitchBgColor" value="#ffffff"
                        style="width: 50px; height: 34px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer;">
                </div>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <canvas id="stitchCanvas"
                style="max-width: 100%; border: 2px solid #ddd; border-radius: 8px; display: none;"></canvas>
            <div id="stitchPlaceholder"
                style="padding: 60px; text-align: center; border: 2px dashed #ccc; border-radius: 8px; color: #999; background: #fafafa;">
                请先上传至少2张图片
            </div>
        </div>

        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
            <button id="downloadStitch" disabled>下载拼接图片</button>
            <button id="resetStitch" style="background: #dc3545;">重置工具</button>
        </div>
    </div>

    <!-- GIF制作工具 -->
    <div class="tab-content" id="gif">
        <h2>GIF动画制作</h2>
        <div class="batch-info">
            🎬 GIF制作：将多张图片合成为GIF动画<br>
            ⏱️ 帧率控制：调整每帧的显示时长<br>
            🔄 循环播放：支持设置循环次数
        </div>

        <label class="drop-area" id="dropGif">拖拽或点击上传图片（支持多选）
            <input type="file" id="uploadGif" accept="image/*" multiple>
        </label>

        <div id="gifImageList" style="display: none; margin: 20px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0; color: #333;">帧列表（拖拽调整顺序）</h4>
                <span id="gifUploadCount"
                    style="background: #0078d4; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 500;"></span>
            </div>
            <div id="gifListContainer"
                style="display: flex; gap: 10px; flex-wrap: wrap; padding: 15px; background: #f8f9fa; border-radius: 8px; min-height: 100px;">
            </div>
        </div>

        <div class="controls" style="flex-direction: column; gap: 20px; margin-top: 20px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button class="gif-delay-btn" data-delay="100" style="background: #6f42c1;">极快(100ms)</button>
                <button class="gif-delay-btn" data-delay="200" style="background: #e83e8c;">快速(200ms)</button>
                <button class="gif-delay-btn" data-delay="500" style="background: #20c997;">正常(500ms)</button>
                <button class="gif-delay-btn" data-delay="1000" style="background: #fd7e14;">慢速(1s)</button>
                <button class="gif-delay-btn" data-delay="2000" style="background: #17a2b8;">很慢(2s)</button>
            </div>

            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: center;">
                <div class="control-group">
                    <label>帧延迟:</label>
                    <input type="number" id="gifDelay" value="500" min="50" max="5000" step="50" style="width: 100px;">
                    <span>毫秒</span>
                </div>

                <div class="control-group">
                    <label>图片质量:</label>
                    <input type="range" id="gifQuality" value="10" min="1" max="30" style="width: 150px;">
                    <span id="gifQualityValue" style="font-weight: 500; color: #0078d4;">10</span>
                    <span style="font-size: 12px; color: #666;">（值越小越清晰）</span>
                </div>

                <div class="control-group">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="gifRepeat" checked style="cursor: pointer;">
                        <span>无限循环</span>
                    </label>
                </div>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <div id="gifPreview"
                style="display: none; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #ddd;">
                <h4 style="margin: 0 0 10px 0; color: #333;">GIF预览</h4>
                <img id="gifPreviewImg" style="max-width: 100%; border-radius: 8px; border: 2px solid #ddd;" />
            </div>
            <div id="gifPlaceholder"
                style="padding: 60px; text-align: center; border: 2px dashed #ccc; border-radius: 8px; color: #999; background: #fafafa;">
                请先上传至少2张图片
            </div>
        </div>

        <div id="gifProgress" style="display: none; margin: 20px 0;">
            <div style="background: #e9ecef; border-radius: 8px; overflow: hidden; height: 30px;">
                <div id="gifProgressBar"
                    style="background: linear-gradient(90deg, #0078d4, #00a8ff); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 14px; font-weight: 500;">
                </div>
            </div>
            <p id="gifProgressText" style="text-align: center; margin: 10px 0 0 0; color: #666; font-size: 14px;"></p>
        </div>

        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
            <button id="generateGif" style="background: #28a745;" disabled>生成GIF</button>
            <button id="downloadGif" disabled>下载GIF</button>
            <button id="resetGif" style="background: #dc3545;">重置工具</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gifshot@0.4.5/dist/gifshot.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        /* ======= 库加载检测 ======= */
        window.addEventListener('load', function () {
            // 检测gifshot是否加载成功
            setTimeout(() => {
                if (typeof gifshot === 'undefined') {
                    console.warn('GIF库未加载，GIF制作功能可能不可用');
                    const generateGifBtn = document.getElementById('generateGif');
                    if (generateGifBtn) {
                        generateGifBtn.title = 'GIF库加载失败，请刷新页面';
                    }
                } else {
                    console.log('GIF库加载成功');
                }
            }, 1000);
        });

        /* ======= 标签页切换 ======= */
        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有活动状态
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // 添加当前标签的活动状态
                    tab.classList.add('active');
                    const targetTab = tab.getAttribute('data-tab');
                    document.getElementById(targetTab).classList.add('active');
                });
            });
        });

        /* ======= 裁剪工具 ======= */
        let cropper, cropFileName = "cropped.png";
        const imageCrop = document.getElementById('imageCrop');
        const uploadCrop = document.getElementById('uploadCrop');
        const downloadCrop = document.getElementById('downloadCrop');
        const applyCrop = document.getElementById('applyCrop');
        const preset1Btn = document.getElementById('preset1');
        const preset2Btn = document.getElementById('preset2');
        const savePresetBtn = document.getElementById('savePreset');
        const managePresetsBtn = document.getElementById('managePresets');
        const customPresetsContainer = document.getElementById('customPresets');

        const posX = document.getElementById('posX');
        const posY = document.getElementById('posY');
        const width = document.getElementById('width');
        const height = document.getElementById('height');

        // 固定预设值
        const CROP_PRESETS = {
            preset1: {
                x: 55,
                y: 0,
                width: 341,
                height: 65
            },
            preset2: {
                x: 65,
                y: 0,
                width: 411,
                height: 65
            }
        };

        // 默认使用预设1
        const DEFAULT_CROP_VALUES = CROP_PRESETS.preset1;

        // localStorage key
        const CUSTOM_PRESETS_KEY = 'cropCustomPresets';

        // 从localStorage加载自定义预设
        function loadCustomPresets() {
            const saved = localStorage.getItem(CUSTOM_PRESETS_KEY);
            return saved ? JSON.parse(saved) : [];
        }

        // 保存自定义预设到localStorage
        function saveCustomPresets(presets) {
            localStorage.setItem(CUSTOM_PRESETS_KEY, JSON.stringify(presets));
        }

        // 渲染自定义预设按钮
        function renderCustomPresets() {
            const customPresets = loadCustomPresets();
            customPresetsContainer.innerHTML = '';

            if (customPresets.length === 0) {
                customPresetsContainer.style.display = 'none';
                return;
            }

            customPresetsContainer.style.display = 'flex';

            customPresets.forEach((preset, index) => {
                const btn = document.createElement('button');
                btn.style.cssText = 'background: #fd7e14; position: relative; padding-right: 35px;';
                btn.innerHTML = `${preset.name || '自定义' + (index + 1)} (${preset.x},${preset.y},${preset.width},${preset.height})`;

                btn.addEventListener('click', () => {
                    applyPreset(preset);
                });

                customPresetsContainer.appendChild(btn);
            });
        }

        function handleCropFile(file) {
            if (!file) return;
            cropFileName = file.name.replace(/\.[^/.]+$/, "") + ".png";
            const url = URL.createObjectURL(file);
            imageCrop.src = url;

            if (cropper) cropper.destroy();
            cropper = new Cropper(imageCrop, {
                aspectRatio: NaN,
                viewMode: 1,
                autoCropArea: 0.3,
                crop(event) {
                    posX.value = Math.round(event.detail.x);
                    posY.value = Math.round(event.detail.y);
                    width.value = Math.round(event.detail.width);
                    height.value = Math.round(event.detail.height);
                },
                ready() {
                    cropper.setData(DEFAULT_CROP_VALUES);
                }
            });
        }

        uploadCrop.addEventListener('change', e => handleCropFile(e.target.files[0]));

        // 拖拽上传
        const dropCrop = document.getElementById('dropCrop');
        dropCrop.addEventListener('dragover', e => { e.preventDefault(); dropCrop.classList.add('hover'); });
        dropCrop.addEventListener('dragleave', e => { e.preventDefault(); dropCrop.classList.remove('hover'); });
        dropCrop.addEventListener('drop', e => {
            e.preventDefault();
            dropCrop.classList.remove('hover');
            const file = e.dataTransfer.files[0];
            handleCropFile(file);
        });

        applyCrop.addEventListener('click', () => {
            if (!cropper) {
                alert("请先上传图片");
                return;
            }

            const x = parseInt(posX.value) || 0;
            const y = parseInt(posY.value) || 0;
            const w = parseInt(width.value) || 100;
            const h = parseInt(height.value) || 100;

            cropper.setData({ x, y, width: w, height: h });
        });

        downloadCrop.addEventListener('click', () => {
            if (!cropper) return alert("请先上传图片");
            const canvas = cropper.getCroppedCanvas();
            canvas.toBlob(blob => {
                const link = document.createElement('a');
                link.download = cropFileName;
                link.href = URL.createObjectURL(blob);
                link.click();
            });
        });

        // 应用预设值的通用函数
        function applyPreset(presetValues) {
            // 更新输入框值
            posX.value = presetValues.x;
            posY.value = presetValues.y;
            width.value = presetValues.width;
            height.value = presetValues.height;

            // 如果有图片，应用裁剪
            if (cropper) {
                cropper.setData(presetValues);
            }
        }

        // 预设1按钮
        preset1Btn.addEventListener('click', () => {
            applyPreset(CROP_PRESETS.preset1);
        });

        // 预设2按钮
        preset2Btn.addEventListener('click', () => {
            applyPreset(CROP_PRESETS.preset2);
        });

        // 保存当前值为预设
        savePresetBtn.addEventListener('click', () => {
            const name = prompt('请输入预设名称：', '我的预设');
            if (!name) return;

            const newPreset = {
                name: name,
                x: parseInt(posX.value) || 0,
                y: parseInt(posY.value) || 0,
                width: parseInt(width.value) || 100,
                height: parseInt(height.value) || 100
            };

            const customPresets = loadCustomPresets();
            customPresets.push(newPreset);
            saveCustomPresets(customPresets);
            renderCustomPresets();

            alert('预设已保存！');
        });

        // 管理预设
        managePresetsBtn.addEventListener('click', () => {
            const customPresets = loadCustomPresets();

            if (customPresets.length === 0) {
                alert('暂无自定义预设');
                return;
            }

            let message = '当前自定义预设列表：\n\n';
            customPresets.forEach((preset, index) => {
                message += `${index + 1}. ${preset.name} (${preset.x},${preset.y},${preset.width},${preset.height})\n`;
            });
            message += '\n输入要删除的预设编号（多个用逗号分隔），或点击取消返回：';

            const input = prompt(message);
            if (!input) return;

            const indexesToDelete = input.split(',').map(i => parseInt(i.trim()) - 1).filter(i => i >= 0 && i < customPresets.length);

            if (indexesToDelete.length === 0) {
                alert('没有有效的编号');
                return;
            }

            // 从后往前删除，避免索引变化
            indexesToDelete.sort((a, b) => b - a).forEach(index => {
                customPresets.splice(index, 1);
            });

            saveCustomPresets(customPresets);
            renderCustomPresets();

            alert(`已删除 ${indexesToDelete.length} 个预设`);
        });

        // 页面加载时渲染自定义预设
        renderCustomPresets();

        // 重置裁剪工具
        const resetCropBtn = document.getElementById('resetCrop');
        resetCropBtn.addEventListener('click', () => {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            imageCrop.src = '';
            uploadCrop.value = '';
            posX.value = 55;
            posY.value = 0;
            width.value = 341;
            height.value = 65;
            cropFileName = "cropped.png";
        });

        /* ======= 颜色替换工具 ======= */
        let uploadedFiles = [];
        let currentFileIndex = 0;
        let processedImages = [];
        let replaceHistoryData = []; // 存储替换历史记录
        let originalImages = []; // 存储原始图片数据

        const uploadReplace = document.getElementById("uploadReplace");
        const fromColor = document.getElementById("fromColor");
        const toColor = document.getElementById("toColor");
        const toleranceInput = document.getElementById("tolerance");
        const downloadReplace = document.getElementById("downloadReplace");
        const downloadAllReplace = document.getElementById("downloadAllReplace");
        const downloadZipReplace = document.getElementById("downloadZipReplace");
        const applyReplace = document.getElementById("applyReplace");
        const replaceHistory = document.getElementById("replaceHistory");
        const historyList = document.getElementById("historyList");
        const undoReplace = document.getElementById("undoReplace");
        const clearHistory = document.getElementById("clearHistory");
        const fromColorPreview = document.getElementById("fromColorPreview");
        const toColorPreview = document.getElementById("toColorPreview");
        const imageGrid = document.getElementById("imageGrid");
        const gridContainer = document.getElementById("gridContainer");
        const uploadCount = document.getElementById("uploadCount");

        // 颜色预览更新
        function updateColorPreviews() {
            try {
                fromColorPreview.style.backgroundColor = fromColor.value;
                toColorPreview.style.backgroundColor = toColor.value;
            } catch (e) {
                console.warn('颜色格式可能不正确:', e);
            }
        }

        fromColor.addEventListener('input', updateColorPreviews);
        toColor.addEventListener('input', updateColorPreviews);

        // 应用颜色替换 - 手动触发
        function applyColorReplace() {
            if (uploadedFiles.length === 0) return;

            // 保存当前状态到历史记录
            const currentState = {
                timestamp: new Date().toLocaleTimeString(),
                fromColor: fromColor.value,
                toColor: toColor.value,
                tolerance: toleranceInput.value,
                processedImages: [...processedImages] // 深拷贝当前处理结果
            };

            replaceHistoryData.push(currentState);
            updateHistoryDisplay();

            // 为每张图片创建处理后的canvas
            uploadedFiles.forEach((file, index) => {
                const img = new Image();
                img.onload = () => {
                    // 创建临时canvas进行处理
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');

                    tempCanvas.width = img.width;
                    tempCanvas.height = img.height;
                    tempCtx.drawImage(img, 0, 0);

                    // 获取图像数据
                    const imgData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                    const data = imgData.data;

                    // 颜色替换处理
                    const [fr, fg, fb] = hexToRgb(fromColor.value);
                    const [tr, tg, tb] = hexToRgb(toColor.value);
                    const tolerance = parseInt(toleranceInput.value) || 0;

                    for (let i = 0; i < data.length; i += 4) {
                        const dr = data[i] - fr;
                        const dg = data[i + 1] - fg;
                        const db = data[i + 2] - fb;
                        const dist = Math.sqrt(dr * dr + dg * dg + db * db);

                        if (dist <= tolerance) {
                            data[i] = tr;
                            data[i + 1] = tg;
                            data[i + 2] = tb;
                        }
                    }

                    // 应用处理后的图像数据
                    tempCtx.putImageData(imgData, 0, 0);

                    // 保存处理后的图片数据
                    processedImages[index] = tempCanvas.toDataURL("image/png");

                    // 更新网格中对应图片的显示
                    updateGridImage(index, processedImages[index]);
                };

                img.onerror = () => {
                    console.error('图片加载失败:', file.name);
                };

                // 使用当前处理后的图片作为输入，如果没有则使用原始图片
                if (processedImages[index]) {
                    img.src = processedImages[index];
                } else {
                    img.src = originalImages[index];
                }
            });
        }

        // 更新网格中指定图片的显示
        function updateGridImage(index, processedImageData) {
            const gridItems = gridContainer.children;
            if (gridItems[index]) {
                const img = gridItems[index].querySelector('img');
                if (img && processedImageData) {
                    img.src = processedImageData;
                }
            }
        }

        // 更新历史记录显示
        function updateHistoryDisplay() {
            if (replaceHistoryData.length === 0) {
                replaceHistory.style.display = 'none';
                undoReplace.disabled = true;
                return;
            }

            replaceHistory.style.display = 'block';
            undoReplace.disabled = false;

            historyList.innerHTML = '';

            replaceHistoryData.forEach((record, index) => {
                const historyItem = document.createElement('div');
                historyItem.style.cssText = `
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #fff;
      border-radius: 6px;
      border: 1px solid #dee2e6;
      font-size: 14px;
    `;

                const colorInfo = document.createElement('div');
                colorInfo.style.cssText = 'display: flex; align-items: center; gap: 8px;';

                const fromColorSpan = document.createElement('span');
                fromColorSpan.style.cssText = `
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background-color: ${record.fromColor};
    `;

                const arrow = document.createElement('span');
                arrow.textContent = '→';
                arrow.style.cssText = 'color: #666; font-weight: bold;';

                const toColorSpan = document.createElement('span');
                toColorSpan.style.cssText = `
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background-color: ${record.toColor};
    `;

                const details = document.createElement('span');
                details.textContent = `${record.fromColor} → ${record.toColor} (容差: ${record.tolerance})`;
                details.style.cssText = 'color: #666; margin-left: 8px;';

                const timeInfo = document.createElement('span');
                timeInfo.textContent = record.timestamp;
                timeInfo.style.cssText = 'color: #999; font-size: 12px;';

                colorInfo.appendChild(fromColorSpan);
                colorInfo.appendChild(arrow);
                colorInfo.appendChild(toColorSpan);
                colorInfo.appendChild(details);

                historyItem.appendChild(colorInfo);
                historyItem.appendChild(timeInfo);

                historyList.appendChild(historyItem);
            });
        }

        // 撤销上一步操作
        function undoLastReplace() {
            if (replaceHistoryData.length === 0) return;

            // 移除最后一条记录
            replaceHistoryData.pop();

            if (replaceHistoryData.length === 0) {
                // 如果没有历史记录，恢复到原始状态
                processedImages = [...originalImages];
                uploadedFiles.forEach((file, index) => {
                    updateGridImage(index, originalImages[index]);
                });
            } else {
                // 恢复到上一步的状态
                const lastRecord = replaceHistoryData[replaceHistoryData.length - 1];
                processedImages = [...lastRecord.processedImages];
                uploadedFiles.forEach((file, index) => {
                    updateGridImage(index, processedImages[index]);
                });
            }

            updateHistoryDisplay();
        }

        // 清空历史记录
        function clearReplaceHistory() {
            replaceHistoryData = [];
            processedImages = [...originalImages];
            uploadedFiles.forEach((file, index) => {
                updateGridImage(index, originalImages[index]);
            });
            updateHistoryDisplay();
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 手动触发颜色替换
        applyReplace.addEventListener('click', applyColorReplace);

        // 撤销和清空历史记录事件
        undoReplace.addEventListener('click', undoLastReplace);
        clearHistory.addEventListener('click', clearReplaceHistory);

        function handleReplaceFiles(files) {
            console.log('上传文件数量:', files.length);

            if (!files || files.length === 0) {
                console.log('没有文件上传');
                return;
            }

            // 验证文件类型
            const validFiles = Array.from(files).filter(file => {
                const isValid = file.type.startsWith('image/');
                if (!isValid) {
                    console.warn('无效文件类型:', file.name, file.type);
                }
                return isValid;
            });

            if (validFiles.length === 0) {
                alert('请上传有效的图片文件');
                return;
            }

            uploadedFiles = validFiles;
            processedImages = new Array(validFiles.length);
            originalImages = new Array(validFiles.length);
            replaceHistoryData = []; // 清空历史记录
            currentFileIndex = 0;

            // 保存原始图片数据
            validFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    originalImages[index] = e.target.result;
                    processedImages[index] = e.target.result; // 初始状态为原始图片
                };
                reader.readAsDataURL(file);
            });

            console.log('有效文件数量:', uploadedFiles.length);

            // 显示图片网格
            imageGrid.style.display = 'block';
            updateImageGrid();

            if (validFiles.length > 1) {
                downloadAllReplace.style.display = 'inline-block';
                downloadZipReplace.style.display = 'inline-block';
            } else {
                downloadAllReplace.style.display = 'none';
                downloadZipReplace.style.display = 'none';
            }

            // 不自动应用颜色替换，等待用户手动点击"应用替换"按钮
        }

        function updateImageGrid() {
            // 更新上传总数
            uploadCount.textContent = `${uploadedFiles.length} 张`;

            // 清空网格
            gridContainer.innerHTML = '';

            // 为每张图片创建网格项
            uploadedFiles.forEach((file, index) => {
                const gridItem = document.createElement('div');
                gridItem.style.cssText = `
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    `;

                const img = document.createElement('img');
                img.style.cssText = `
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    `;

                // 显示原始图片
                const url = URL.createObjectURL(file);
                img.src = url;

                // 添加文件名标签
                const fileName = document.createElement('div');
                fileName.textContent = file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name;
                fileName.style.cssText = `
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      color: #fff;
      padding: 8px 6px 6px;
      font-size: 11px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
    `;

                // 添加序号标识
                const orderBadge = document.createElement('div');
                orderBadge.textContent = index + 1;
                orderBadge.style.cssText = `
      position: absolute;
      top: 6px;
      left: 6px;
      background: #0078d4;
      color: #fff;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    `;

                gridItem.appendChild(img);
                gridItem.appendChild(fileName);
                gridItem.appendChild(orderBadge);
                gridContainer.appendChild(gridItem);

                // 添加悬停效果
                gridItem.addEventListener('mouseenter', () => {
                    gridItem.style.transform = 'scale(1.05)';
                });

                gridItem.addEventListener('mouseleave', () => {
                    gridItem.style.transform = 'scale(1)';
                });
            });
        }

        uploadReplace.addEventListener("change", e => handleReplaceFiles(e.target.files));

        const dropReplace = document.getElementById('dropReplace');
        dropReplace.addEventListener('dragover', e => { e.preventDefault(); dropReplace.classList.add('hover'); });
        dropReplace.addEventListener('dragleave', e => { e.preventDefault(); dropReplace.classList.remove('hover'); });
        dropReplace.addEventListener('drop', e => {
            e.preventDefault();
            dropReplace.classList.remove('hover');
            handleReplaceFiles(e.dataTransfer.files);
        });

        // 将颜色值转换为RGB数组，支持十六进制（#ff0000）和命名颜色（red）
        function colorToRgb(color) {
            // 去除空格
            color = color.trim();

            // 如果是十六进制颜色
            if (color.startsWith('#')) {
                const hex = color.replace("#", "");
                const bigint = parseInt(hex, 16);
                return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
            }

            // 如果是rgb/rgba格式
            if (color.startsWith('rgb')) {
                const match = color.match(/\d+/g);
                if (match && match.length >= 3) {
                    return [parseInt(match[0]), parseInt(match[1]), parseInt(match[2])];
                }
            }

            // 对于命名颜色，使用canvas来转换
            const canvas = document.createElement('canvas');
            canvas.width = canvas.height = 1;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color;
            ctx.fillRect(0, 0, 1, 1);
            const imageData = ctx.getImageData(0, 0, 1, 1).data;
            return [imageData[0], imageData[1], imageData[2]];
        }

        // 保留旧函数名以兼容
        function hexToRgb(hex) {
            return colorToRgb(hex);
        }

        downloadReplace.addEventListener("click", () => {
            if (uploadedFiles.length === 0) return;
            if (!processedImages[currentFileIndex]) return;

            const link = document.createElement("a");
            const originalName = uploadedFiles[currentFileIndex].name.replace(/\.[^/.]+$/, "");
            const fileName = `${originalName}.png`; // 保持原始文件名
            link.download = fileName;
            link.href = processedImages[currentFileIndex];
            link.click();
        });

        downloadAllReplace.addEventListener("click", () => {
            if (uploadedFiles.length === 0) return;

            // 检查是否所有图片都已处理
            const allProcessed = processedImages.every(img => img !== undefined);
            if (!allProcessed) return;

            // 批量下载所有图片
            uploadedFiles.forEach((file, index) => {
                setTimeout(() => {
                    const link = document.createElement("a");
                    const originalName = file.name.replace(/\.[^/.]+$/, "");
                    const fileName = `${originalName}.png`; // 保持原始文件名
                    link.download = fileName;
                    link.href = processedImages[index];
                    link.click();
                }, index * 200);
            });
        });

        // 压缩包下载功能
        downloadZipReplace.addEventListener("click", async () => {
            if (uploadedFiles.length === 0) return;

            // 检查是否所有图片都已处理
            const allProcessed = processedImages.every(img => img !== undefined);
            if (!allProcessed) return;

            // 检查JSZip是否加载
            if (typeof JSZip === 'undefined') {
                alert('压缩包功能需要JSZip库，请刷新页面重试');
                return;
            }

            try {
                const zip = new JSZip();

                // 添加所有处理后的图片到压缩包
                uploadedFiles.forEach((file, index) => {
                    const originalName = file.name.replace(/\.[^/.]+$/, "");
                    const fileName = `${originalName}.png`; // 保持原始文件名

                    // 将base64转换为blob
                    const base64Data = processedImages[index].split(',')[1];
                    zip.file(fileName, base64Data, { base64: true });
                });

                // 生成压缩包
                const zipBlob = await zip.generateAsync({ type: 'blob' });

                // 下载压缩包
                const link = document.createElement('a');
                link.download = 'color_replaced_images.zip'; // 简化的压缩包名称
                link.href = URL.createObjectURL(zipBlob);
                link.click();

                // 清理URL
                setTimeout(() => URL.revokeObjectURL(link.href), 1000);

            } catch (error) {
                console.error('压缩包生成失败:', error);
                alert('压缩包生成失败，请重试');
            }
        });

        // 重置颜色替换工具
        const resetReplaceBtn = document.getElementById('resetReplace');
        resetReplaceBtn.addEventListener('click', () => {
            uploadedFiles = [];
            processedImages = [];
            originalImages = [];
            replaceHistoryData = [];
            currentFileIndex = 0;
            uploadReplace.value = '';
            imageGrid.style.display = 'none';
            gridContainer.innerHTML = '';
            replaceHistory.style.display = 'none';
            downloadAllReplace.style.display = 'none';
            downloadZipReplace.style.display = 'none';
            fromColor.value = '#000000';
            toColor.value = '#ff0000';
            toleranceInput.value = 999;
            updateColorPreviews();
        });

        /* ======= 批量重命名工具 ======= */
        let renameFiles = [];

        const uploadRename = document.getElementById("uploadRename");
        const dropRename = document.getElementById("dropRename");
        const renameImageGrid = document.getElementById("renameImageGrid");
        const renameGridContainer = document.getElementById("renameGridContainer");
        const renameUploadCount = document.getElementById("renameUploadCount");
        const targetFormat = document.getElementById("targetFormat");
        const downloadAllRenamed = document.getElementById("downloadAllRenamed");
        const formatBtns = document.querySelectorAll(".format-btn");

        // 格式按钮点击
        formatBtns.forEach(btn => {
            btn.addEventListener("click", () => {
                const format = btn.getAttribute("data-format");
                targetFormat.value = format;
                if (renameFiles.length > 0) {
                    updateRenameGrid();
                }
            });
        });

        // 目标格式改变
        targetFormat.addEventListener("change", () => {
            if (renameFiles.length > 0) {
                updateRenameGrid();
            }
        });

        // 处理上传的文件
        function handleRenameFiles(files) {
            if (!files || files.length === 0) return;

            const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

            if (validFiles.length === 0) {
                alert('请上传有效的图片文件');
                return;
            }

            renameFiles = validFiles;

            renameImageGrid.style.display = 'block';
            downloadAllRenamed.style.display = 'inline-block';

            updateRenameGrid();
        }

        // 更新图片列表显示
        function updateRenameGrid() {
            renameUploadCount.textContent = `已上传 ${renameFiles.length} 张`;
            renameGridContainer.innerHTML = '';

            renameFiles.forEach((file, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = `
      display: flex;
      align-items: center;
      background: #fff;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    `;

                const img = document.createElement('img');
                img.style.cssText = `
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 15px;
      border: 2px solid #dee2e6;
    `;
                img.src = URL.createObjectURL(file);

                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = `
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
    `;

                const originalName = document.createElement('div');
                originalName.style.cssText = `
      font-size: 14px;
      color: #666;
      font-weight: 400;
    `;
                originalName.textContent = `原文件: ${file.name}`;

                const arrow = document.createElement('div');
                arrow.style.cssText = `
      font-size: 16px;
      color: #0078d4;
      font-weight: bold;
    `;
                arrow.textContent = '↓';

                const newName = document.createElement('div');
                newName.style.cssText = `
      font-size: 14px;
      color: #0078d4;
      font-weight: 500;
    `;
                newName.id = `newName-${index}`;
                const newFileName = getNewFileName(file.name, targetFormat.value);
                newName.textContent = `新文件: ${newFileName}`;

                infoDiv.appendChild(originalName);
                infoDiv.appendChild(arrow);
                infoDiv.appendChild(newName);

                itemDiv.appendChild(img);
                itemDiv.appendChild(infoDiv);

                // 悬停效果
                itemDiv.addEventListener('mouseenter', () => {
                    itemDiv.style.transform = 'translateX(5px)';
                    itemDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                });

                itemDiv.addEventListener('mouseleave', () => {
                    itemDiv.style.transform = 'translateX(0)';
                    itemDiv.style.boxShadow = '0 2px 6px rgba(0,0,0,0.08)';
                });

                renameGridContainer.appendChild(itemDiv);
            });
        }

        // 获取新文件名
        function getNewFileName(originalName, format) {
            const nameWithoutExt = originalName.replace(/\.[^/.]+$/, "");
            return `${nameWithoutExt}.${format}`;
        }

        // 文件上传事件
        uploadRename.addEventListener("change", e => handleRenameFiles(e.target.files));

        // 拖拽上传
        dropRename.addEventListener('dragover', e => {
            e.preventDefault();
            dropRename.classList.add('hover');
        });

        dropRename.addEventListener('dragleave', e => {
            e.preventDefault();
            dropRename.classList.remove('hover');
        });

        dropRename.addEventListener('drop', e => {
            e.preventDefault();
            dropRename.classList.remove('hover');
            handleRenameFiles(e.dataTransfer.files);
        });

        // 下载所有重命名后的图片
        downloadAllRenamed.addEventListener("click", () => {
            if (renameFiles.length === 0) return;

            const format = targetFormat.value;

            renameFiles.forEach((file, index) => {
                setTimeout(() => {
                    const link = document.createElement("a");
                    const newFileName = getNewFileName(file.name, format);
                    link.download = newFileName;
                    link.href = URL.createObjectURL(file);
                    link.click();
                }, index * 200);
            });
        });

        // 重置批量重命名工具
        const resetRenameBtn = document.getElementById('resetRename');
        resetRenameBtn.addEventListener('click', () => {
            renameFiles = [];
            uploadRename.value = '';
            renameImageGrid.style.display = 'none';
            renameGridContainer.innerHTML = '';
            downloadAllRenamed.style.display = 'none';
            targetFormat.value = 'png';
        });

        /* ======= 图片叠加工具 ======= */
        let backgroundImg = null;
        let overlayImg = null;
        let overlayX = 0;
        let overlayY = 0;
        let overlayWidth = 0;
        let overlayHeight = 0;
        let overlayOpacityValue = 1;
        let isDragging = false;
        let isResizing = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let resizeCorner = null;
        let overlayAspectRatio = 1;

        const uploadBackground = document.getElementById("uploadBackground");
        const uploadOverlayImg = document.getElementById("uploadOverlay");
        const dropBackground = document.getElementById("dropBackground");
        const dropOverlayArea = document.getElementById("dropOverlay");
        const overlayCanvas = document.getElementById("overlayCanvas");
        const overlayPlaceholder = document.getElementById("overlayPlaceholder");
        const ctx = overlayCanvas.getContext("2d");

        const centerHorizontalBtn = document.getElementById("centerHorizontal");
        const centerVerticalBtn = document.getElementById("centerVertical");
        const centerBothBtn = document.getElementById("centerBoth");
        const resetOverlayBtn = document.getElementById("resetOverlay");
        const fitToBackgroundBtn = document.getElementById("fitToBackground");
        const overlayOpacitySlider = document.getElementById("overlayOpacity");
        const opacityValueSpan = document.getElementById("opacityValue");
        const downloadOverlayBtn = document.getElementById("downloadOverlay");

        // 上传背景图片
        function handleBackgroundUpload(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    backgroundImg = img;
                    initializeCanvas();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // 上传叠加图片
        function handleOverlayUpload(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    overlayImg = img;
                    overlayAspectRatio = img.width / img.height;
                    initializeCanvas();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // 初始化画布
        function initializeCanvas() {
            if (!backgroundImg) return;

            // 设置画布大小为背景图片大小
            overlayCanvas.width = backgroundImg.width;
            overlayCanvas.height = backgroundImg.height;

            overlayCanvas.style.display = 'block';
            overlayPlaceholder.style.display = 'none';

            // 如果有叠加图片，初始化其位置和大小
            if (overlayImg) {
                const scale = Math.min(
                    (backgroundImg.width * 0.5) / overlayImg.width,
                    (backgroundImg.height * 0.5) / overlayImg.height
                );
                overlayWidth = overlayImg.width * scale;
                overlayHeight = overlayImg.height * scale;
                overlayX = (backgroundImg.width - overlayWidth) / 2;
                overlayY = (backgroundImg.height - overlayHeight) / 2;

                // 启用所有控制按钮
                centerHorizontalBtn.disabled = false;
                centerVerticalBtn.disabled = false;
                centerBothBtn.disabled = false;
                resetOverlayBtn.disabled = false;
                fitToBackgroundBtn.disabled = false;
                overlayOpacitySlider.disabled = false;
                downloadOverlayBtn.disabled = false;
            }

            drawCanvas();
        }

        // 绘制画布
        function drawCanvas() {
            if (!backgroundImg) return;

            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

            // 绘制背景图片
            ctx.drawImage(backgroundImg, 0, 0);

            // 如果有叠加图片，绘制叠加图片及控制元素
            if (overlayImg) {
                // 绘制叠加图片
                ctx.globalAlpha = overlayOpacityValue;
                ctx.drawImage(overlayImg, overlayX, overlayY, overlayWidth, overlayHeight);
                ctx.globalAlpha = 1;

                // 绘制叠加图片的边框和控制点
                ctx.strokeStyle = '#0078d4';
                ctx.lineWidth = 2;
                ctx.strokeRect(overlayX, overlayY, overlayWidth, overlayHeight);

                // 绘制四个角的控制点
                const corners = [
                    { x: overlayX, y: overlayY, cursor: 'nw-resize' },
                    { x: overlayX + overlayWidth, y: overlayY, cursor: 'ne-resize' },
                    { x: overlayX, y: overlayY + overlayHeight, cursor: 'sw-resize' },
                    { x: overlayX + overlayWidth, y: overlayY + overlayHeight, cursor: 'se-resize' }
                ];

                ctx.fillStyle = '#0078d4';
                corners.forEach(corner => {
                    ctx.fillRect(corner.x - 5, corner.y - 5, 10, 10);
                });
            }
        }

        // 获取鼠标在画布上的位置
        function getMousePos(e) {
            const rect = overlayCanvas.getBoundingClientRect();
            const scaleX = overlayCanvas.width / rect.width;
            const scaleY = overlayCanvas.height / rect.height;

            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        // 检查是否在控制点上
        function getResizeCorner(x, y) {
            const corners = [
                { x: overlayX, y: overlayY, name: 'nw' },
                { x: overlayX + overlayWidth, y: overlayY, name: 'ne' },
                { x: overlayX, y: overlayY + overlayHeight, name: 'sw' },
                { x: overlayX + overlayWidth, y: overlayY + overlayHeight, name: 'se' }
            ];

            for (let corner of corners) {
                const distance = Math.sqrt((x - corner.x) ** 2 + (y - corner.y) ** 2);
                if (distance < 10) {
                    return corner.name;
                }
            }
            return null;
        }

        // 鼠标按下事件
        overlayCanvas.addEventListener('mousedown', (e) => {
            if (!backgroundImg || !overlayImg) return;

            const pos = getMousePos(e);
            resizeCorner = getResizeCorner(pos.x, pos.y);

            if (resizeCorner) {
                isResizing = true;
                dragStartX = pos.x;
                dragStartY = pos.y;
            } else if (pos.x >= overlayX && pos.x <= overlayX + overlayWidth &&
                pos.y >= overlayY && pos.y <= overlayY + overlayHeight) {
                isDragging = true;
                dragStartX = pos.x - overlayX;
                dragStartY = pos.y - overlayY;
            }
        });

        // 鼠标移动事件
        overlayCanvas.addEventListener('mousemove', (e) => {
            if (!backgroundImg || !overlayImg) return;

            const pos = getMousePos(e);

            if (isDragging) {
                overlayX = pos.x - dragStartX;
                overlayY = pos.y - dragStartY;

                // 限制在画布范围内
                overlayX = Math.max(0, Math.min(overlayX, overlayCanvas.width - overlayWidth));
                overlayY = Math.max(0, Math.min(overlayY, overlayCanvas.height - overlayHeight));

                drawCanvas();
            } else if (isResizing) {
                const deltaX = pos.x - dragStartX;
                const deltaY = pos.y - dragStartY;

                let newWidth = overlayWidth;
                let newHeight = overlayHeight;
                let newX = overlayX;
                let newY = overlayY;

                // 根据拖拽的角计算新的尺寸，保持纵横比
                if (resizeCorner === 'se') {
                    newWidth = overlayWidth + deltaX;
                    newHeight = newWidth / overlayAspectRatio;
                } else if (resizeCorner === 'sw') {
                    newWidth = overlayWidth - deltaX;
                    newHeight = newWidth / overlayAspectRatio;
                    newX = overlayX + deltaX;
                } else if (resizeCorner === 'ne') {
                    newWidth = overlayWidth + deltaX;
                    newHeight = newWidth / overlayAspectRatio;
                    newY = overlayY - (newHeight - overlayHeight);
                } else if (resizeCorner === 'nw') {
                    newWidth = overlayWidth - deltaX;
                    newHeight = newWidth / overlayAspectRatio;
                    newX = overlayX + deltaX;
                    newY = overlayY - (newHeight - overlayHeight);
                }

                // 确保尺寸不小于10px
                if (newWidth > 10 && newHeight > 10) {
                    overlayWidth = newWidth;
                    overlayHeight = newHeight;
                    overlayX = newX;
                    overlayY = newY;
                    dragStartX = pos.x;
                    dragStartY = pos.y;
                    drawCanvas();
                }
            } else {
                // 更新鼠标样式
                const corner = getResizeCorner(pos.x, pos.y);
                if (corner) {
                    overlayCanvas.style.cursor = corner + '-resize';
                } else if (pos.x >= overlayX && pos.x <= overlayX + overlayWidth &&
                    pos.y >= overlayY && pos.y <= overlayY + overlayHeight) {
                    overlayCanvas.style.cursor = 'move';
                } else {
                    overlayCanvas.style.cursor = 'default';
                }
            }
        });

        // 鼠标释放事件
        overlayCanvas.addEventListener('mouseup', () => {
            isDragging = false;
            isResizing = false;
            resizeCorner = null;
        });

        overlayCanvas.addEventListener('mouseleave', () => {
            isDragging = false;
            isResizing = false;
            resizeCorner = null;
        });

        // 水平居中
        centerHorizontalBtn.addEventListener('click', () => {
            overlayX = (overlayCanvas.width - overlayWidth) / 2;
            drawCanvas();
        });

        // 垂直居中
        centerVerticalBtn.addEventListener('click', () => {
            overlayY = (overlayCanvas.height - overlayHeight) / 2;
            drawCanvas();
        });

        // 完全居中
        centerBothBtn.addEventListener('click', () => {
            overlayX = (overlayCanvas.width - overlayWidth) / 2;
            overlayY = (overlayCanvas.height - overlayHeight) / 2;
            drawCanvas();
        });

        // 重置位置
        resetOverlayBtn.addEventListener('click', () => {
            if (!backgroundImg || !overlayImg) return;

            const scale = Math.min(
                (backgroundImg.width * 0.5) / overlayImg.width,
                (backgroundImg.height * 0.5) / overlayImg.height
            );
            overlayWidth = overlayImg.width * scale;
            overlayHeight = overlayImg.height * scale;
            overlayX = (backgroundImg.width - overlayWidth) / 2;
            overlayY = (backgroundImg.height - overlayHeight) / 2;

            drawCanvas();
        });

        // 适应背景
        fitToBackgroundBtn.addEventListener('click', () => {
            if (!backgroundImg || !overlayImg) return;

            const scale = Math.min(
                backgroundImg.width / overlayImg.width,
                backgroundImg.height / overlayImg.height
            );
            overlayWidth = overlayImg.width * scale;
            overlayHeight = overlayImg.height * scale;
            overlayX = (backgroundImg.width - overlayWidth) / 2;
            overlayY = (backgroundImg.height - overlayHeight) / 2;

            drawCanvas();
        });

        // 不透明度调整
        overlayOpacitySlider.addEventListener('input', () => {
            overlayOpacityValue = overlayOpacitySlider.value / 100;
            opacityValueSpan.textContent = overlayOpacitySlider.value + '%';
            drawCanvas();
        });

        // 下载合成图片
        downloadOverlayBtn.addEventListener('click', () => {
            if (!backgroundImg || !overlayImg) return;

            // 创建最终合成的canvas
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = overlayCanvas.width;
            finalCanvas.height = overlayCanvas.height;
            const finalCtx = finalCanvas.getContext('2d');

            // 绘制背景
            finalCtx.drawImage(backgroundImg, 0, 0);

            // 绘制叠加图片
            finalCtx.globalAlpha = overlayOpacityValue;
            finalCtx.drawImage(overlayImg, overlayX, overlayY, overlayWidth, overlayHeight);
            finalCtx.globalAlpha = 1;

            // 下载
            finalCanvas.toBlob(blob => {
                const link = document.createElement('a');
                link.download = 'overlay_result.png';
                link.href = URL.createObjectURL(blob);
                link.click();
            });
        });

        // 文件上传事件
        uploadBackground.addEventListener('change', e => handleBackgroundUpload(e.target.files[0]));
        uploadOverlayImg.addEventListener('change', e => handleOverlayUpload(e.target.files[0]));

        // 拖拽上传 - 背景图片
        dropBackground.addEventListener('dragover', e => {
            e.preventDefault();
            dropBackground.classList.add('hover');
        });

        dropBackground.addEventListener('dragleave', e => {
            e.preventDefault();
            dropBackground.classList.remove('hover');
        });

        dropBackground.addEventListener('drop', e => {
            e.preventDefault();
            dropBackground.classList.remove('hover');
            handleBackgroundUpload(e.dataTransfer.files[0]);
        });

        // 拖拽上传 - 叠加图片
        dropOverlayArea.addEventListener('dragover', e => {
            e.preventDefault();
            dropOverlayArea.classList.add('hover');
        });

        dropOverlayArea.addEventListener('dragleave', e => {
            e.preventDefault();
            dropOverlayArea.classList.remove('hover');
        });

        dropOverlayArea.addEventListener('drop', e => {
            e.preventDefault();
            dropOverlayArea.classList.remove('hover');
            handleOverlayUpload(e.dataTransfer.files[0]);
        });

        // 重置图片叠加工具
        const resetOverlayToolBtn = document.getElementById('resetOverlayTool');
        resetOverlayToolBtn.addEventListener('click', () => {
            // 清空图片
            backgroundImg = null;
            overlayImg = null;
            overlayX = 0;
            overlayY = 0;
            overlayWidth = 0;
            overlayHeight = 0;
            overlayOpacityValue = 1;
            isDragging = false;
            isResizing = false;
            resizeCorner = null;
            overlayAspectRatio = 1;

            // 清空输入
            uploadBackground.value = '';
            uploadOverlayImg.value = '';

            // 清空画布
            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            overlayCanvas.style.display = 'none';
            overlayPlaceholder.style.display = 'block';

            // 禁用按钮
            centerHorizontalBtn.disabled = true;
            centerVerticalBtn.disabled = true;
            centerBothBtn.disabled = true;
            resetOverlayBtn.disabled = true;
            fitToBackgroundBtn.disabled = true;
            overlayOpacitySlider.disabled = true;
            downloadOverlayBtn.disabled = true;

            // 重置不透明度
            overlayOpacitySlider.value = 100;
            opacityValueSpan.textContent = '100%';
        });

        /* ======= 图片拼接工具 ======= */
        let stitchImages = [];
        let stitchImagesData = [];
        let draggedIndex = null;

        const uploadStitch = document.getElementById("uploadStitch");
        const dropStitch = document.getElementById("dropStitch");
        const stitchImageList = document.getElementById("stitchImageList");
        const stitchListContainer = document.getElementById("stitchListContainer");
        const stitchUploadCount = document.getElementById("stitchUploadCount");
        const stitchMode = document.getElementById("stitchMode");
        const stitchGap = document.getElementById("stitchGap");
        const stitchBgColor = document.getElementById("stitchBgColor");
        const stitchCanvas = document.getElementById("stitchCanvas");
        const stitchPlaceholder = document.getElementById("stitchPlaceholder");
        const downloadStitchBtn = document.getElementById("downloadStitch");
        const resetStitchBtn = document.getElementById("resetStitch");
        const stitchModeBtns = document.querySelectorAll(".stitch-mode-btn");
        const stitchCtx = stitchCanvas.getContext("2d");

        // 模式按钮点击
        stitchModeBtns.forEach(btn => {
            btn.addEventListener("click", () => {
                const mode = btn.getAttribute("data-mode");
                stitchMode.value = mode;
                if (stitchImagesData.length >= 2) {
                    stitchImagesFunc();
                }
            });
        });

        // 处理上传的文件
        function handleStitchFiles(files) {
            if (!files || files.length === 0) return;

            const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
            if (validFiles.length === 0) return;

            // 加载图片
            const loadPromises = validFiles.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            resolve({ file, img, url: e.target.result });
                        };
                        img.onerror = () => resolve(null);
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            });

            Promise.all(loadPromises).then(results => {
                const validResults = results.filter(r => r !== null);
                stitchImagesData = stitchImagesData.concat(validResults);
                updateStitchList();

                if (stitchImagesData.length >= 2) {
                    stitchImagesFunc();
                }
            });
        }

        // 更新图片列表显示
        function updateStitchList() {
            if (stitchImagesData.length === 0) {
                stitchImageList.style.display = 'none';
                return;
            }

            stitchImageList.style.display = 'block';
            stitchUploadCount.textContent = `${stitchImagesData.length} 张`;
            stitchListContainer.innerHTML = '';

            stitchImagesData.forEach((data, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.draggable = true;
                itemDiv.dataset.index = index;
                itemDiv.style.cssText = `
      position: relative;
      width: 100px;
      height: 100px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      overflow: hidden;
      cursor: move;
      transition: all 0.3s ease;
      background: #fff;
    `;

                const img = document.createElement('img');
                img.src = data.url;
                img.style.cssText = `
      width: 100%;
      height: 100%;
      object-fit: cover;
    `;

                const orderBadge = document.createElement('div');
                orderBadge.textContent = index + 1;
                orderBadge.style.cssText = `
      position: absolute;
      top: 5px;
      left: 5px;
      background: #0078d4;
      color: #fff;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    `;

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '×';
                deleteBtn.style.cssText = `
      position: absolute;
      top: 5px;
      right: 5px;
      background: #dc3545;
      color: #fff;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      line-height: 20px;
      padding: 0;
    `;

                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    stitchImagesData.splice(index, 1);
                    updateStitchList();
                    if (stitchImagesData.length < 2) {
                        downloadStitchBtn.disabled = true;
                        stitchCanvas.style.display = 'none';
                        stitchPlaceholder.style.display = 'block';
                    } else {
                        stitchImagesFunc();
                    }
                });

                // 拖拽事件
                itemDiv.addEventListener('dragstart', (e) => {
                    draggedIndex = index;
                    itemDiv.style.opacity = '0.5';
                });

                itemDiv.addEventListener('dragend', (e) => {
                    itemDiv.style.opacity = '1';
                });

                itemDiv.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    itemDiv.style.borderColor = '#0078d4';
                });

                itemDiv.addEventListener('dragleave', (e) => {
                    itemDiv.style.borderColor = '#dee2e6';
                });

                itemDiv.addEventListener('drop', (e) => {
                    e.preventDefault();
                    itemDiv.style.borderColor = '#dee2e6';

                    if (draggedIndex !== null && draggedIndex !== index) {
                        const draggedItem = stitchImagesData[draggedIndex];
                        stitchImagesData.splice(draggedIndex, 1);
                        stitchImagesData.splice(index, 0, draggedItem);
                        updateStitchList();
                        draggedIndex = null;
                        if (stitchImagesData.length >= 2) {
                            stitchImagesFunc();
                        }
                    }
                });

                itemDiv.addEventListener('mouseenter', () => {
                    itemDiv.style.transform = 'scale(1.05)';
                    itemDiv.style.borderColor = '#0078d4';
                });

                itemDiv.addEventListener('mouseleave', () => {
                    itemDiv.style.transform = 'scale(1)';
                    itemDiv.style.borderColor = '#dee2e6';
                });

                itemDiv.appendChild(img);
                itemDiv.appendChild(orderBadge);
                itemDiv.appendChild(deleteBtn);
                stitchListContainer.appendChild(itemDiv);
            });
        }

        // 拼接图片
        function stitchImagesFunc() {
            if (stitchImagesData.length < 2) return;

            const mode = stitchMode.value;
            const gap = parseInt(stitchGap.value) || 0;
            const bgColor = stitchBgColor.value;

            let canvasWidth = 0;
            let canvasHeight = 0;
            let positions = [];

            if (mode === 'horizontal') {
                // 水平拼接
                const maxHeight = Math.max(...stitchImagesData.map(d => d.img.height));
                canvasWidth = stitchImagesData.reduce((sum, d) => sum + d.img.width, 0) + gap * (stitchImagesData.length - 1);
                canvasHeight = maxHeight;

                let x = 0;
                stitchImagesData.forEach(data => {
                    positions.push({ x, y: (maxHeight - data.img.height) / 2, width: data.img.width, height: data.img.height, img: data.img });
                    x += data.img.width + gap;
                });
            } else if (mode === 'vertical') {
                // 垂直拼接
                const maxWidth = Math.max(...stitchImagesData.map(d => d.img.width));
                canvasWidth = maxWidth;
                canvasHeight = stitchImagesData.reduce((sum, d) => sum + d.img.height, 0) + gap * (stitchImagesData.length - 1);

                let y = 0;
                stitchImagesData.forEach(data => {
                    positions.push({ x: (maxWidth - data.img.width) / 2, y, width: data.img.width, height: data.img.height, img: data.img });
                    y += data.img.height + gap;
                });
            } else if (mode.startsWith('row')) {
                // 一行N个的网格布局
                const perRow = parseInt(mode.replace('row', ''));
                const totalImages = stitchImagesData.length;
                const rows = Math.ceil(totalImages / perRow);

                // 计算每个单元格的大小（取最大宽高）
                const maxWidth = Math.max(...stitchImagesData.map(d => d.img.width));
                const maxHeight = Math.max(...stitchImagesData.map(d => d.img.height));

                canvasWidth = maxWidth * perRow + gap * (perRow - 1);
                canvasHeight = maxHeight * rows + gap * (rows - 1);

                stitchImagesData.forEach((data, index) => {
                    const row = Math.floor(index / perRow);
                    const col = index % perRow;

                    // 计算当前行有多少个图片
                    const imagesInCurrentRow = (row === rows - 1) ? (totalImages % perRow || perRow) : perRow;

                    // 如果是最后一行且不满，居中显示
                    let offsetX = 0;
                    if (imagesInCurrentRow < perRow) {
                        offsetX = ((perRow - imagesInCurrentRow) * (maxWidth + gap)) / 2;
                    }

                    const x = offsetX + col * (maxWidth + gap) + (maxWidth - data.img.width) / 2;
                    const y = row * (maxHeight + gap) + (maxHeight - data.img.height) / 2;
                    positions.push({ x, y, width: data.img.width, height: data.img.height, img: data.img });
                });
            }

            // 绘制到画布
            stitchCanvas.width = canvasWidth;
            stitchCanvas.height = canvasHeight;

            // 填充背景色
            stitchCtx.fillStyle = bgColor;
            stitchCtx.fillRect(0, 0, canvasWidth, canvasHeight);

            // 绘制所有图片
            positions.forEach(pos => {
                stitchCtx.drawImage(pos.img, pos.x, pos.y, pos.width, pos.height);
            });

            stitchCanvas.style.display = 'block';
            stitchPlaceholder.style.display = 'none';
            downloadStitchBtn.disabled = false;
        }

        // 参数改变时自动预览
        stitchMode.addEventListener("change", () => {
            if (stitchImagesData.length >= 2 && stitchCanvas.style.display === 'block') {
                stitchImagesFunc();
            }
        });

        stitchGap.addEventListener("input", () => {
            if (stitchImagesData.length >= 2 && stitchCanvas.style.display === 'block') {
                stitchImagesFunc();
            }
        });

        stitchBgColor.addEventListener("input", () => {
            if (stitchImagesData.length >= 2 && stitchCanvas.style.display === 'block') {
                stitchImagesFunc();
            }
        });

        // 下载拼接图片
        downloadStitchBtn.addEventListener("click", () => {
            if (stitchImagesData.length < 2) return;

            stitchCanvas.toBlob(blob => {
                const link = document.createElement('a');
                link.download = 'stitched_image.png';
                link.href = URL.createObjectURL(blob);
                link.click();
            });
        });

        // 重置
        resetStitchBtn.addEventListener("click", () => {
            stitchImagesData = [];
            uploadStitch.value = '';
            stitchImageList.style.display = 'none';
            stitchListContainer.innerHTML = '';
            stitchCanvas.style.display = 'none';
            stitchPlaceholder.style.display = 'block';
            downloadStitchBtn.disabled = true;
            stitchMode.value = 'row3';
            stitchGap.value = 0;
            stitchBgColor.value = '#ffffff';
        });

        // 文件上传事件
        uploadStitch.addEventListener("change", e => handleStitchFiles(e.target.files));

        // 拖拽上传
        dropStitch.addEventListener('dragover', e => {
            e.preventDefault();
            dropStitch.classList.add('hover');
        });

        dropStitch.addEventListener('dragleave', e => {
            e.preventDefault();
            dropStitch.classList.remove('hover');
        });

        dropStitch.addEventListener('drop', e => {
            e.preventDefault();
            dropStitch.classList.remove('hover');
            handleStitchFiles(e.dataTransfer.files);
        });

        /* ======= GIF制作工具 ======= */
        let gifImagesData = [];
        let gifDraggedIndex = null;
        let generatedGifBlob = null;

        const uploadGif = document.getElementById("uploadGif");
        const dropGif = document.getElementById("dropGif");
        const gifImageList = document.getElementById("gifImageList");
        const gifListContainer = document.getElementById("gifListContainer");
        const gifUploadCount = document.getElementById("gifUploadCount");
        const gifDelay = document.getElementById("gifDelay");
        const gifQuality = document.getElementById("gifQuality");
        const gifQualityValue = document.getElementById("gifQualityValue");
        const gifRepeat = document.getElementById("gifRepeat");
        const generateGifBtn = document.getElementById("generateGif");
        const downloadGifBtn = document.getElementById("downloadGif");
        const resetGifBtn = document.getElementById("resetGif");
        const gifDelayBtns = document.querySelectorAll(".gif-delay-btn");
        const gifPreview = document.getElementById("gifPreview");
        const gifPreviewImg = document.getElementById("gifPreviewImg");
        const gifPlaceholder = document.getElementById("gifPlaceholder");
        const gifProgress = document.getElementById("gifProgress");
        const gifProgressBar = document.getElementById("gifProgressBar");
        const gifProgressText = document.getElementById("gifProgressText");

        // 质量滑块更新
        gifQuality.addEventListener("input", () => {
            gifQualityValue.textContent = gifQuality.value;
        });

        // 延迟按钮点击
        gifDelayBtns.forEach(btn => {
            btn.addEventListener("click", () => {
                const delay = btn.getAttribute("data-delay");
                gifDelay.value = delay;
            });
        });

        // 处理上传的文件
        function handleGifFiles(files) {
            if (!files || files.length === 0) return;

            const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
            if (validFiles.length === 0) return;

            // 加载图片
            const loadPromises = validFiles.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            resolve({ file, img, url: e.target.result });
                        };
                        img.onerror = () => resolve(null);
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            });

            Promise.all(loadPromises).then(results => {
                const validResults = results.filter(r => r !== null);
                gifImagesData = gifImagesData.concat(validResults);
                updateGifList();

                if (gifImagesData.length >= 2) {
                    generateGifBtn.disabled = false;
                }
            });
        }

        // 更新图片列表显示
        function updateGifList() {
            if (gifImagesData.length === 0) {
                gifImageList.style.display = 'none';
                return;
            }

            gifImageList.style.display = 'block';
            gifUploadCount.textContent = `${gifImagesData.length} 帧`;
            gifListContainer.innerHTML = '';

            gifImagesData.forEach((data, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.draggable = true;
                itemDiv.dataset.index = index;
                itemDiv.style.cssText = `
      position: relative;
      width: 100px;
      height: 100px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      overflow: hidden;
      cursor: move;
      transition: all 0.3s ease;
      background: #fff;
    `;

                const img = document.createElement('img');
                img.src = data.url;
                img.style.cssText = `
      width: 100%;
      height: 100%;
      object-fit: cover;
    `;

                const orderBadge = document.createElement('div');
                orderBadge.textContent = index + 1;
                orderBadge.style.cssText = `
      position: absolute;
      top: 5px;
      left: 5px;
      background: #0078d4;
      color: #fff;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    `;

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '×';
                deleteBtn.style.cssText = `
      position: absolute;
      top: 5px;
      right: 5px;
      background: #dc3545;
      color: #fff;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      line-height: 20px;
      padding: 0;
    `;

                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    gifImagesData.splice(index, 1);
                    updateGifList();
                    if (gifImagesData.length < 2) {
                        generateGifBtn.disabled = true;
                        downloadGifBtn.disabled = true;
                        gifPreview.style.display = 'none';
                        gifPlaceholder.style.display = 'block';
                    }
                });

                // 拖拽事件
                itemDiv.addEventListener('dragstart', (e) => {
                    gifDraggedIndex = index;
                    itemDiv.style.opacity = '0.5';
                });

                itemDiv.addEventListener('dragend', (e) => {
                    itemDiv.style.opacity = '1';
                });

                itemDiv.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    itemDiv.style.borderColor = '#0078d4';
                });

                itemDiv.addEventListener('dragleave', (e) => {
                    itemDiv.style.borderColor = '#dee2e6';
                });

                itemDiv.addEventListener('drop', (e) => {
                    e.preventDefault();
                    itemDiv.style.borderColor = '#dee2e6';

                    if (gifDraggedIndex !== null && gifDraggedIndex !== index) {
                        const draggedItem = gifImagesData[gifDraggedIndex];
                        gifImagesData.splice(gifDraggedIndex, 1);
                        gifImagesData.splice(index, 0, draggedItem);
                        updateGifList();
                        gifDraggedIndex = null;
                    }
                });

                itemDiv.addEventListener('mouseenter', () => {
                    itemDiv.style.transform = 'scale(1.05)';
                    itemDiv.style.borderColor = '#0078d4';
                });

                itemDiv.addEventListener('mouseleave', () => {
                    itemDiv.style.transform = 'scale(1)';
                    itemDiv.style.borderColor = '#dee2e6';
                });

                itemDiv.appendChild(img);
                itemDiv.appendChild(orderBadge);
                itemDiv.appendChild(deleteBtn);
                gifListContainer.appendChild(itemDiv);
            });
        }

        // 生成GIF
        generateGifBtn.addEventListener("click", () => {
            if (gifImagesData.length < 2) return;

            // 检查gifshot是否加载
            if (typeof gifshot === 'undefined') {
                alert('GIF库加载失败，请刷新页面重试');
                return;
            }

            const delay = parseInt(gifDelay.value) || 500;
            const interval = delay / 1000; // 转换为秒
            const numFrames = gifImagesData.length;

            // 显示进度条
            gifProgress.style.display = 'block';
            gifProgressBar.style.width = '10%';
            gifProgressBar.textContent = '10%';
            gifProgressText.textContent = '正在生成GIF...';
            generateGifBtn.disabled = true;

            // 准备图片URL数组
            const imageUrls = gifImagesData.map(d => d.url);

            // 使用gifshot生成GIF
            gifshot.createGIF({
                images: imageUrls,
                gifWidth: Math.max(...gifImagesData.map(d => d.img.width)),
                gifHeight: Math.max(...gifImagesData.map(d => d.img.height)),
                interval: interval,
                numFrames: numFrames,
                frameDuration: 1,
                sampleInterval: 10,
                numWorkers: 2
            }, function (obj) {
                if (!obj.error) {
                    // 更新进度
                    gifProgressBar.style.width = '100%';
                    gifProgressBar.textContent = '100%';
                    gifProgressText.textContent = '✓ GIF生成完成！';

                    // 将base64转换为blob
                    const base64Data = obj.image.split(',')[1];
                    const byteCharacters = atob(base64Data);
                    const byteArrays = [];

                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteArrays.push(byteCharacters.charCodeAt(i));
                    }

                    generatedGifBlob = new Blob([new Uint8Array(byteArrays)], { type: 'image/gif' });

                    // 显示预览
                    gifPreviewImg.src = obj.image;
                    gifPreview.style.display = 'block';
                    gifPlaceholder.style.display = 'none';

                    downloadGifBtn.disabled = false;
                    generateGifBtn.disabled = false;

                    // 3秒后隐藏进度条
                    setTimeout(() => {
                        gifProgress.style.display = 'none';
                    }, 3000);
                } else {
                    gifProgressText.textContent = '✗ 生成失败，请重试';
                    generateGifBtn.disabled = false;
                    console.error('GIF生成错误:', obj.error);
                }
            });

            // 模拟进度更新
            let progress = 10;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += 10;
                    gifProgressBar.style.width = progress + '%';
                    gifProgressBar.textContent = progress + '%';
                } else {
                    clearInterval(progressInterval);
                }
            }, 200);
        });

        // 下载GIF
        downloadGifBtn.addEventListener("click", () => {
            if (!generatedGifBlob) return;

            const link = document.createElement('a');
            link.download = 'animated.gif';
            link.href = URL.createObjectURL(generatedGifBlob);
            link.click();
        });

        // 重置
        resetGifBtn.addEventListener("click", () => {
            gifImagesData = [];
            generatedGifBlob = null;
            uploadGif.value = '';
            gifImageList.style.display = 'none';
            gifListContainer.innerHTML = '';
            gifPreview.style.display = 'none';
            gifPlaceholder.style.display = 'block';
            gifProgress.style.display = 'none';
            generateGifBtn.disabled = true;
            downloadGifBtn.disabled = true;
            gifDelay.value = 500;
            gifQuality.value = 10;
            gifQualityValue.textContent = '10';
            gifRepeat.checked = true;
        });

        // 文件上传事件
        uploadGif.addEventListener("change", e => handleGifFiles(e.target.files));

        // 拖拽上传
        dropGif.addEventListener('dragover', e => {
            e.preventDefault();
            dropGif.classList.add('hover');
        });

        dropGif.addEventListener('dragleave', e => {
            e.preventDefault();
            dropGif.classList.remove('hover');
        });

        dropGif.addEventListener('drop', e => {
            e.preventDefault();
            dropGif.classList.remove('hover');
            handleGifFiles(e.dataTransfer.files);
        });
    </script>
</body>

</html>